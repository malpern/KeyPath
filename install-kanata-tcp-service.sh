#!/bin/bash

echo "🔧 Installing Kanata LaunchDaemon service with TCP support..."
echo "This script will install com.keypath.kanata.plist with --port 37000"
echo ""

# Check if running as root
if [[ $EUID -eq 0 ]]; then
    echo "❌ This script should NOT be run as root. Run as regular user - it will ask for sudo when needed."
    exit 1
fi

# Check if kanata binary exists
if [[ ! -f "/usr/local/bin/kanata" ]]; then
    echo "❌ Kanata binary not found at /usr/local/bin/kanata"
    echo "   Please install kanata first: brew install kanata"
    exit 1
fi

# Create user config directory if it doesn't exist
CONFIG_DIR="$HOME/.config/keypath"
if [[ ! -d "$CONFIG_DIR" ]]; then
    echo "📁 Creating user config directory: $CONFIG_DIR"
    mkdir -p "$CONFIG_DIR"
fi

# Create basic config file if it doesn't exist
CONFIG_FILE="$CONFIG_DIR/keypath.kbd"
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "📝 Creating basic config file: $CONFIG_FILE"
    cat > "$CONFIG_FILE" << 'CONFIG_EOF'
;; Generated by KeyPath
;; Input: caps -> Output: escape
;;
;; SAFETY FEATURES:
;; - process-unmapped-keys no: Only process explicitly mapped keys

(defcfg
  process-unmapped-keys no
)

(defsrc caps)
(deflayer base esc)
CONFIG_EOF
fi

echo "📋 Config file ready at: $CONFIG_FILE"
echo ""

# Remove existing service if it exists
if [[ -f "/Library/LaunchDaemons/com.keypath.kanata.plist" ]]; then
    echo "🔄 Removing existing service..."
    sudo launchctl unload /Library/LaunchDaemons/com.keypath.kanata.plist 2>/dev/null || true
    sudo rm /Library/LaunchDaemons/com.keypath.kanata.plist
fi

# Create the new plist with TCP support
echo "📄 Creating LaunchDaemon plist with TCP server (port 37000)..."
sudo tee /Library/LaunchDaemons/com.keypath.kanata.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.keypath.kanata</string>
    <key>Program</key>
    <string>/usr/local/bin/kanata</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/kanata</string>
        <string>--cfg</string>
        <string>/Users/malpern/.config/keypath/keypath.kbd</string>
        <string>--port</string>
        <string>37000</string>
        <string>--watch</string>
        <string>--debug</string>
        <string>--log-layer-changes</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/var/log/kanata.log</string>
    <key>StandardErrorPath</key>
    <string>/var/log/kanata.log</string>
</dict>
</plist>
EOF

# Set proper ownership and permissions
sudo chown root:wheel /Library/LaunchDaemons/com.keypath.kanata.plist
sudo chmod 644 /Library/LaunchDaemons/com.keypath.kanata.plist

echo "✅ LaunchDaemon plist created successfully"

# Load the service
echo "🚀 Loading and starting the service..."
sudo launchctl load /Library/LaunchDaemons/com.keypath.kanata.plist
sudo launchctl kickstart -k system/com.keypath.kanata

echo ""
echo "🎯 Installation complete!"
echo ""

# Wait a moment for service to start
sleep 2

# Verify the installation
echo "🔍 Verification:"
echo ""

# Check if service is loaded
if sudo launchctl print system/com.keypath.kanata >/dev/null 2>&1; then
    echo "✅ Service loaded: com.keypath.kanata"
else
    echo "❌ Service not loaded"
fi

# Check if kanata process is running
if pgrep -f kanata >/dev/null; then
    echo "✅ Kanata process is running"
    echo "   Process: $(ps aux | grep kanata | grep -v grep | head -1)"
else
    echo "❌ Kanata process not running"
fi

# Check if TCP server is listening
if lsof -i :37000 >/dev/null 2>&1; then
    echo "✅ TCP server listening on port 37000"
    echo "   $(lsof -i :37000)"
else
    echo "❌ TCP server not listening on port 37000"
fi

echo ""
echo "📝 To check logs: tail -f /var/log/kanata.log"
echo "🔧 To restart service: sudo launchctl kickstart -k system/com.keypath.kanata"
echo "🛑 To stop service: sudo launchctl kill TERM system/com.keypath.kanata"