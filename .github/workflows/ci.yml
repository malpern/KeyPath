name: KeyPath CI

on:
  push:
    branches: [ main, master, split-arch, another-light-refactor ]
  pull_request:
    branches: [ main, master, split-arch ]

jobs:
  build-and-test:
    runs-on: macos-latest
    timeout-minutes: 15
    env:
      COVERAGE_BASELINE_PERCENT: "0.29"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cache Swift packages
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/.swiftpm
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift', 'Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swift-
    
    - name: Install Kanata
      run: |
        echo "üì¶ Installing Kanata..."
        brew install kanata
        echo "‚úÖ Kanata installed: $(which kanata)"
        kanata --version

    - name: Lint WizardAutoFixer for forbidden subprocess usage
      run: |
        chmod +x ./Scripts/lint-no-subprocess-in-autofixer.sh
        ./Scripts/lint-no-subprocess-in-autofixer.sh
    
    - name: Build Project
      run: |
        echo "üî® Building project..."
        swift build
        echo "‚úÖ Build completed successfully"

    - name: "Smoke: Signing and Installer Engine"
      run: |
        echo "üß™ Running signing/notarization wrappers and installer E2E smoke tests"
        export KP_SIGN_DRY_RUN=1
        swift test --filter SigningPipelineTests
        swift test --filter InstallerEngineEndToEndTests

    - name: Verify SMAppService plist wrapper
      run: |
        echo "üîç Verifying com.keypath.kanata.plist points at kanata-launcher"
        ./Scripts/verify-kanata-plist.sh Sources/KeyPathApp/com.keypath.kanata.plist
    
    - name: Run CI-Safe Tests (Safe Test Runner)
      run: |
        echo "üß™ Running KeyPath CI-safe tests with safe test runner"
        export CI_ENVIRONMENT=true
        export SKIP_EVENT_TAP_TESTS=1
        export TIMEOUT_SECONDS=180

        # Release-gating behavior: any non-zero exit should fail CI.
        chmod +x ./Scripts/run-tests-safe.sh
        ./Scripts/run-tests-safe.sh
        echo "‚úÖ All tests passed"
        echo "TEST_STATUS=passed" >> $GITHUB_ENV

    - name: Generate Coverage Artifacts (informational baseline)
      run: |
        echo "üìä Generating coverage baseline artifacts..."
        # Keep runtime bounded with representative suites for baseline reporting.
        swift test --enable-code-coverage --filter KeyPathErrorTests
        swift test --enable-code-coverage --filter PermissionOracleTests
        chmod +x ./Scripts/generate-coverage.sh
        ./Scripts/generate-coverage.sh coverage

    - name: Enforce Coverage Non-Regression (Narrow Lane)
      run: |
        echo "üìè Enforcing narrow-lane coverage floor (${COVERAGE_BASELINE_PERCENT}%)..."
        if [ ! -f "coverage/coverage-summary.txt" ]; then
          echo "‚ùå Missing coverage/coverage-summary.txt"
          exit 1
        fi

        ACTUAL_COVERAGE=$(awk '/^TOTAL/ {for(i=1;i<=NF;i++) if ($i ~ /%$/) {gsub("%","",$i); print $i; exit}}' coverage/coverage-summary.txt)
        if [ -z "${ACTUAL_COVERAGE}" ]; then
          echo "‚ùå Could not parse TOTAL coverage from coverage/coverage-summary.txt"
          cat coverage/coverage-summary.txt
          exit 1
        fi

        echo "Coverage (narrow lane): ${ACTUAL_COVERAGE}%"
        if awk -v actual="${ACTUAL_COVERAGE}" -v baseline="${COVERAGE_BASELINE_PERCENT}" 'BEGIN {exit !(actual + 0 >= baseline + 0)}'; then
          echo "‚úÖ Coverage is non-regressing (>= ${COVERAGE_BASELINE_PERCENT}%)"
        else
          echo "‚ùå Coverage regression: ${ACTUAL_COVERAGE}% < ${COVERAGE_BASELINE_PERCENT}%"
          exit 1
        fi
    
    - name: Upload Test Results
      if: always()  # Upload results even if tests failed
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          .build/debug/
          test_output.safe.txt
          coverage/
        if-no-files-found: ignore
        retention-days: 7
    
    - name: Generate Test Summary
      if: always()
      run: |
        echo "üìã Generating test summary..."
        set +e  # Don't fail on summary generation
        
        # Create summary for GitHub Actions
        echo "## üß™ KeyPath Full Test Results" >> $GITHUB_STEP_SUMMARY
        
        if [ "${TEST_STATUS:-unknown}" = "failed" ]; then
          echo "‚ùå **Tests Failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some tests failed. Check the test-results artifact for detailed logs." >> $GITHUB_STEP_SUMMARY
        elif [ "${TEST_STATUS:-unknown}" = "passed" ]; then
          echo "‚úÖ **All Tests Passed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full test suite executed successfully including:" >> $GITHUB_STEP_SUMMARY
          echo "- Unit tests (core functionality)" >> $GITHUB_STEP_SUMMARY
          echo "- Integration tests (system interactions)" >> $GITHUB_STEP_SUMMARY
          echo "- UDP client tests (network communication)" >> $GITHUB_STEP_SUMMARY
          echo "- Manager tests (service coordination)" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è **Test Status Unknown**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test status: ${TEST_STATUS:-unknown}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìä Test Coverage" >> $GITHUB_STEP_SUMMARY
        if [ -f "coverage/coverage-summary.txt" ]; then
          echo "- Baseline: \`$(cat coverage/coverage-summary.txt)\`" >> $GITHUB_STEP_SUMMARY
          echo "- Enforced narrow-lane floor: \`${COVERAGE_BASELINE_PERCENT}%\`" >> $GITHUB_STEP_SUMMARY
          echo "- Detailed report attached in test-results artifact (\`coverage/\`)." >> $GITHUB_STEP_SUMMARY
        else
          echo "- Coverage baseline artifact was not generated in this run." >> $GITHUB_STEP_SUMMARY
        fi
        echo "- This workflow enforces build + smoke suites + CI-safe test pass/fail." >> $GITHUB_STEP_SUMMARY
        echo "- Runner: swift test (XCTest + Swift Testing targets)." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ‚ö†Ô∏è Known Issues" >> $GITHUB_STEP_SUMMARY
        echo "- No test-failure pass-through is allowed in this workflow." >> $GITHUB_STEP_SUMMARY
        echo "- Some privileged integration coverage remains opt-in outside default CI." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Job summary generated at run-time*" >> $GITHUB_STEP_SUMMARY
        
        set -e  # Re-enable error checking
    
    - name: Build Release
      run: |
        echo "üî® Building release version..."
        swift build -c release
        echo "‚úÖ Release build successful"
    
    - name: Check Build Outputs
      run: |
        echo "üîç Checking build outputs..."
        echo "Debug build:"
        ls -la .build/debug/ | head -10 || echo "No debug build found"
        echo ""
        echo "Release build:"
        ls -la .build/release/ | head -10 || echo "No release build found"
        
        # Verify KeyPath binary was created
        if [ -f ".build/release/KeyPath" ]; then
          echo "‚úÖ KeyPath binary created successfully"
          echo "üì¶ Binary size: $(ls -lh .build/release/KeyPath | awk '{print $5}')"
          echo "üîß Binary info:"
          file .build/release/KeyPath || echo "file command not available"
        else
          echo "‚ö†Ô∏è KeyPath binary not found"
        fi
        
        echo "‚úÖ Build verification completed"
    
    - name: Upload Build Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: keypath-release-binary
        path: .build/release/KeyPath
        retention-days: 30

  code-quality:
    runs-on: macos-latest
    timeout-minutes: 8
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Tools (optional)
      run: |
        # Install SwiftLint for linting
        if ! command -v swiftlint &> /dev/null; then
          echo "üì¶ Installing SwiftLint..."
          brew install swiftlint
        fi
        
        # Install SwiftFormat for formatting checks
        if ! command -v swiftformat &> /dev/null; then
          echo "üì¶ Installing SwiftFormat..."
          brew install swiftformat
        fi
    
    - name: SwiftLint Analysis
      run: |
        echo "üîç Running comprehensive SwiftLint analysis..."
        
        # Full SwiftLint check (moved from pre-commit)
        echo "üìã SwiftLint Report:"
        if swiftlint --reporter github-actions-logging; then
          echo "‚úÖ No SwiftLint violations found"
          SWIFTLINT_STATUS="passed"
        else
          echo "‚ö†Ô∏è SwiftLint found issues (details above)"
          SWIFTLINT_STATUS="issues_found"
          # Don't fail CI, just report
        fi
        
        # Store status for summary
        echo "SWIFTLINT_STATUS=$SWIFTLINT_STATUS" >> $GITHUB_ENV
        echo "‚úÖ SwiftLint analysis completed"
    
    - name: SwiftFormat Check
      run: |
        echo "üìù Checking Swift formatting..."
        # Use --lint to check formatting without modifying files
        swiftformat --lint Sources/ Tests/ || {
          echo "‚ö†Ô∏è SwiftFormat found formatting issues, but not failing CI"
          echo "üí° Run 'swiftformat Sources/ Tests/' locally to fix formatting"
          exit 0
        }
        echo "‚úÖ SwiftFormat check completed"

    - name: Wizard Sleep Lint
      run: |
        echo "‚è±Ô∏è Ensuring wizard code has no Task.sleep calls..."
        chmod +x ./Scripts/lint-no-sleep.sh
        ./Scripts/lint-no-sleep.sh
        echo "‚úÖ Wizard sleep lint passed"

    - name: Accessibility Check
      run: |
        echo "‚ôø Checking accessibility identifiers..."
        python3 Scripts/check-accessibility.py || {
          echo "‚ö†Ô∏è Some UI elements are missing accessibility identifiers"
          echo "üí° See ACCESSIBILITY_COVERAGE.md for examples"
          echo "üí° Add .accessibilityIdentifier() to all Button/Toggle/Picker elements"
          # Don't fail CI yet - allow gradual adoption
          exit 0
        }
        echo "‚úÖ All UI elements have accessibility identifiers"

    - name: Critical Pattern Analysis
      run: |
        echo "üîç Running critical code pattern checks (moved from pre-commit)..."
        
        # Critical TODOs/FIXMEs (blocking issues)
        echo "üìã Checking for critical TODOs/FIXMEs..."
        if grep -r 'TODO.*CRITICAL\|FIXME.*URGENT' Sources/ --include='*.swift'; then
          echo "‚ùå CRITICAL issues found that should block deployment"
          echo "CRITICAL_ISSUES=found" >> $GITHUB_ENV
        else
          echo "‚úÖ No critical TODOs/FIXMEs found"
          echo "CRITICAL_ISSUES=none" >> $GITHUB_ENV
        fi
        
        echo "‚úÖ Critical pattern analysis completed"
    
    - name: Code Smell Detection  
      run: |
        echo "üîç Running code smell detection (moved from pre-commit)..."
        
        FORCE_UNWRAPS=0
        PRINT_STATEMENTS=0
        
        # Check for force unwraps in critical manager files
        echo "üìã Checking for force unwraps in manager files..."
        if grep -r "!" Sources/KeyPath/Managers/ --include="*.swift" | grep -v "!=" | grep -v "// swiftlint:disable" >/dev/null 2>&1; then
          echo "‚ö†Ô∏è Force unwraps found in manager files:"
          grep -r "!" Sources/KeyPath/Managers/ --include="*.swift" | grep -v "!=" | grep -v "// swiftlint:disable" | head -10
          FORCE_UNWRAPS=1
        else
          echo "‚úÖ No problematic force unwraps in manager files"
        fi
        
        # Check for print statements (should use Logger)
        echo "üìã Checking for print statements..."
        if grep -r "print(" Sources/ --include="*.swift" | grep -v "// debug" >/dev/null 2>&1; then
          echo "‚ö†Ô∏è print() statements found (consider using Logger):"
          grep -r "print(" Sources/ --include="*.swift" | grep -v "// debug" | head -10
          PRINT_STATEMENTS=1
        else
          echo "‚úÖ No print() statements found"
        fi
        
        # Store results for summary
        echo "FORCE_UNWRAPS=$FORCE_UNWRAPS" >> $GITHUB_ENV
        echo "PRINT_STATEMENTS=$PRINT_STATEMENTS" >> $GITHUB_ENV
        
        echo "‚úÖ Code smell detection completed"
    
    - name: Additional Code Quality
      run: |
        echo "üîç Additional code quality checks..."
        
        # Check for general TODO/FIXME (informational)
        echo "üìã Checking for general TODO/FIXME comments..."
        if grep -r "TODO\|FIXME" Sources/ --include="*.swift" | head -10; then
          echo "‚ÑπÔ∏è Found TODO/FIXME comments (informational)"
          echo "TODO_COMMENTS=found" >> $GITHUB_ENV
        else
          echo "‚úÖ No TODO/FIXME comments found" 
          echo "TODO_COMMENTS=none" >> $GITHUB_ENV
        fi
        
        echo "‚úÖ Additional quality checks completed"
    
    - name: Generate Code Quality Summary
      if: always()
      run: |
        echo "üìã Generating comprehensive code quality summary..."
        
        echo "## üîç Code Quality Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # SwiftLint results
        echo "### üìã SwiftLint Analysis (moved from pre-commit)" >> $GITHUB_STEP_SUMMARY
        if [ "${SWIFTLINT_STATUS:-unknown}" = "passed" ]; then
          echo "‚úÖ **No SwiftLint violations found**" >> $GITHUB_STEP_SUMMARY
        elif [ "${SWIFTLINT_STATUS:-unknown}" = "issues_found" ]; then
          echo "‚ö†Ô∏è **SwiftLint issues detected** - See job logs for details" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ÑπÔ∏è SwiftLint status unknown" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # SwiftFormat results
        echo "### üìù SwiftFormat Analysis" >> $GITHUB_STEP_SUMMARY
        echo "‚ÑπÔ∏è Formatting check completed (pre-commit handles auto-fixes)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Critical patterns
        echo "### üö® Critical Pattern Analysis (moved from pre-commit)" >> $GITHUB_STEP_SUMMARY
        if [ "${CRITICAL_ISSUES:-unknown}" = "none" ]; then
          echo "‚úÖ **No critical TODOs/FIXMEs found**" >> $GITHUB_STEP_SUMMARY
        elif [ "${CRITICAL_ISSUES:-unknown}" = "found" ]; then
          echo "‚ùå **CRITICAL issues found** - Review urgently" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ÑπÔ∏è Critical pattern status unknown" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Code smell detection
        echo "### üîç Code Smell Detection (moved from pre-commit)" >> $GITHUB_STEP_SUMMARY
        SMELLS_FOUND=0
        if [ "${FORCE_UNWRAPS:-0}" = "1" ]; then
          echo "‚ö†Ô∏è Force unwraps found in manager files" >> $GITHUB_STEP_SUMMARY
          SMELLS_FOUND=1
        fi
        if [ "${PRINT_STATEMENTS:-0}" = "1" ]; then
          echo "‚ö†Ô∏è print() statements found (consider using Logger)" >> $GITHUB_STEP_SUMMARY 
          SMELLS_FOUND=1
        fi
        if [ "$SMELLS_FOUND" = "0" ]; then
          echo "‚úÖ **No code smells detected**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # General TODO/FIXME
        echo "### üìù General TODO/FIXME Comments" >> $GITHUB_STEP_SUMMARY
        if [ "${TODO_COMMENTS:-unknown}" = "none" ]; then
          echo "‚úÖ No TODO/FIXME comments found" >> $GITHUB_STEP_SUMMARY
        elif [ "${TODO_COMMENTS:-unknown}" = "found" ]; then
          echo "‚ÑπÔ∏è TODO/FIXME comments present (informational)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "### üéØ Pre-commit vs CI Responsibilities" >> $GITHUB_STEP_SUMMARY
        echo "- **Pre-commit:** SwiftFormat + SwiftLint auto-fixes only" >> $GITHUB_STEP_SUMMARY 
        echo "- **CI:** Comprehensive analysis, reporting, and quality gates" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Most checks are informational and do not block CI*" >> $GITHUB_STEP_SUMMARY
