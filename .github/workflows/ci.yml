name: KeyPath CI

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

on:
  push:
    branches: [ main, master, split-arch, another-light-refactor ]
  pull_request:
    branches: [ main, master, split-arch ]
  workflow_dispatch: {}

jobs:
  build-and-test:
    runs-on: macos-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cache Swift packages
      uses: actions/cache@v3
      with:
        path: .build
        key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-swift-
    
    - name: Install Kanata
      run: |
        echo "ðŸ“¦ Installing Kanata..."
        brew install kanata
        echo "âœ… Kanata installed: $(which kanata)"
        kanata --version
    
    - name: Build Project
      run: |
        echo "ðŸ”¨ Building project..."
        swift build
        echo "âœ… Build completed successfully"
    
    - name: Run All Tests (Core Test Runner)
      run: |
        echo "ðŸ§ª Running KeyPath tests with run-core-tests.sh"
        echo "   - Uses improved test runner with pipefail (Phase 0)"
        echo "   - Proper test filtering and timeout handling"
        echo "   - Consistent between local and CI"
        export SKIP_EVENT_TAP_TESTS=1

        # Use the core test runner script (Phase 0 improvements)
        # - set -o pipefail for proper error detection
        # - Correct test suite filters
        # - CI environment auto-detected
        # - Tests complete in <5s after perf improvements (commit d6a9b2f)
        if ./run-core-tests.sh; then
          echo "âœ… All tests passed"
          echo "TEST_STATUS=passed" >> $GITHUB_ENV
        else
          TEST_EXIT=$?
          echo "âŒ Tests failed with exit code $TEST_EXIT"
          echo "TEST_STATUS=failed" >> $GITHUB_ENV
          echo "âŒ FAILING CI - Test failures must be fixed"
          exit 1
        fi
    
    - name: Upload Test Results
      if: always()  # Upload results even if tests failed
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: .build/debug/
        retention-days: 7
    
    - name: Generate Test Summary
      if: always()
      run: |
        echo "ðŸ“‹ Generating test summary..."
        
        # Create summary for GitHub Actions
        echo "## ðŸ§ª KeyPath Full Test Results" >> $GITHUB_STEP_SUMMARY
        
        if [ "$TEST_STATUS" = "failed" ]; then
          echo "âŒ **Tests Failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some tests failed. Build verification continued." >> $GITHUB_STEP_SUMMARY
          echo "Check the test-results artifact for detailed logs." >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **All Tests Passed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full test suite executed successfully including:" >> $GITHUB_STEP_SUMMARY
          echo "- Unit tests (core functionality)" >> $GITHUB_STEP_SUMMARY
          echo "- Integration tests (system interactions)" >> $GITHUB_STEP_SUMMARY
          echo "- UDP client tests (network communication)" >> $GITHUB_STEP_SUMMARY
          echo "- Manager tests (service coordination)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Test Coverage" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Frameworks:** XCTest + Swift Testing (56 new tests)" >> $GITHUB_STEP_SUMMARY
        echo "- **New Tests:** KeyPathError, PermissionOracle, UserNotifications, MainAppStateController" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Tests:** ~106 tests (50 XCTest + 56 Swift Testing)" >> $GITHUB_STEP_SUMMARY
        echo "- **Runner:** swift test (supports both frameworks)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ Known Issues" >> $GITHUB_STEP_SUMMARY
        echo "- Some pre-existing tests have Swift 6 concurrency errors" >> $GITHUB_STEP_SUMMARY
        echo "- Integration tests requiring sudo may be skipped in CI" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY

    # Removed duplicate lcov install from code-quality; installed in build-and-test

    - name: Generate Coverage (reuse existing)
      if: always()
      run: |
        echo "ðŸ“Š Generating coverage (reuse existing profdata)"
        bash Scripts/generate-coverage.sh --reuse || true

    - name: Ensure Coverage HTML
      if: always()
      run: |
        set -e
        echo "ðŸŒ Ensuring HTML coverage exists"
        if command -v genhtml >/dev/null 2>&1 && [ -f dist/coverage/coverage.lcov ]; then
          genhtml -o dist/coverage/html dist/coverage/coverage.lcov || true
        fi
        if [ ! -f dist/coverage/html/index.html ]; then
          echo "<!doctype html><meta charset=\"utf-8\"><title>Coverage</title><p>No coverage HTML found. See artifact contents." > dist/coverage/html/index.html
        fi
        echo "Listing coverage HTML directory:" 
        ls -la dist/coverage/html || true

    - name: Upload Coverage Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage
        path: dist/coverage
        retention-days: 7

    - name: Append Coverage Summary
      if: always()
      run: |
        echo "### ðŸ“Š Coverage Summary" >> $GITHUB_STEP_SUMMARY
        if [ -f dist/coverage/summary_app_target.txt ]; then
          LINE=$(tail -n 1 dist/coverage/summary_app_target.txt | sed -E 's/\x1b\[[0-9;]*m//g')
          echo "Using app target summary (excludes Tests/)" >> $GITHUB_STEP_SUMMARY
        else
          LINE=$(tail -n 1 dist/coverage/summary.txt | sed -E 's/\x1b\[[0-9;]*m//g')
          echo "Using full summary (includes Tests/)" >> $GITHUB_STEP_SUMMARY
        fi
        RE='[0-9]+\.[0-9]+%'
        PCTS=$(echo "$LINE" | grep -Eo "$RE" || true)
        REGIONS=$(echo "$PCTS" | sed -n '1p')
        FUNCS=$(echo "$PCTS" | sed -n '2p')
        LINES=$(echo "$PCTS" | sed -n '3p')
        echo "- Regions: ${REGIONS:-n/a}" >> $GITHUB_STEP_SUMMARY
        echo "- Functions: ${FUNCS:-n/a}" >> $GITHUB_STEP_SUMMARY
        echo "- Lines: ${LINES:-n/a}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Artifacts: dist/coverage" >> $GITHUB_STEP_SUMMARY

    - name: Upload Pages Artifact (coverage HTML)
      if: ${{ always() && hashFiles('dist/coverage/html/index.html') != '' }}
      uses: actions/upload-pages-artifact@v3
      with:
        path: dist/coverage/html
    
    - name: Build Release
      run: |
        echo "ðŸ”¨ Building release version..."
        swift build -c release
        echo "âœ… Release build successful"
    
    - name: Check Build Outputs
      run: |
        echo "ðŸ” Checking build outputs..."
        echo "Debug build:"
        ls -la .build/debug/ | head -10 || echo "No debug build found"
        echo ""
        echo "Release build:"
        ls -la .build/release/ | head -10 || echo "No release build found"
        
        # Verify KeyPath binary was created
        if [ -f ".build/release/KeyPath" ]; then
          echo "âœ… KeyPath binary created successfully"
          echo "ðŸ“¦ Binary size: $(ls -lh .build/release/KeyPath | awk '{print $5}')"
          echo "ðŸ”§ Binary info:"
          file .build/release/KeyPath || echo "file command not available"
        else
          echo "âš ï¸ KeyPath binary not found"
        fi
        
        echo "âœ… Build verification completed"
    
    - name: Upload Build Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: keypath-release-binary
        path: .build/release/KeyPath
        retention-days: 30

  deploy-pages:
    if: ${{ github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' }}
    needs: build-and-test
    runs-on: ubuntu-latest
    continue-on-error: true
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      - name: Add Pages Link to Summary
        run: |
          echo "### ðŸŒ Coverage Report (GitHub Pages)" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
      - name: Comment PR with coverage link
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        env:
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
        with:
          script: |
            const pageUrl = process.env.PAGE_URL || '';
            const body = `ðŸ” Coverage Report: ${pageUrl}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });

  code-quality:
    runs-on: macos-latest
    timeout-minutes: 8
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Tools (optional)
      run: |
        # Install SwiftLint for linting
        if ! command -v swiftlint &> /dev/null; then
          echo "ðŸ“¦ Installing SwiftLint..."
          brew install swiftlint
        fi
        
        # Install SwiftFormat for formatting checks
        if ! command -v swiftformat &> /dev/null; then
          echo "ðŸ“¦ Installing SwiftFormat..."
          brew install swiftformat
        fi
    
    - name: SwiftLint Analysis
      run: |
        echo "ðŸ” Running comprehensive SwiftLint analysis..."
        
        # Full SwiftLint check (moved from pre-commit)
        echo "ðŸ“‹ SwiftLint Report:"
        if swiftlint --reporter github-actions-logging; then
          echo "âœ… No SwiftLint violations found"
          SWIFTLINT_STATUS="passed"
        else
          echo "âš ï¸ SwiftLint found issues (details above)"
          SWIFTLINT_STATUS="issues_found"
          # Don't fail CI, just report
        fi
        
        # Store status for summary
        echo "SWIFTLINT_STATUS=$SWIFTLINT_STATUS" >> $GITHUB_ENV
        echo "âœ… SwiftLint analysis completed"
    
    - name: SwiftFormat Check
      run: |
        echo "ðŸ“ Checking Swift formatting..."
        # Use --lint to check formatting without modifying files
        swiftformat --lint Sources/ Tests/ || {
          echo "âš ï¸ SwiftFormat found formatting issues, but not failing CI"
          echo "ðŸ’¡ Run 'swiftformat Sources/ Tests/' locally to fix formatting"
          exit 0
        }
        echo "âœ… SwiftFormat check completed"
    
    - name: Critical Pattern Analysis
      run: |
        echo "ðŸ” Running critical code pattern checks (moved from pre-commit)..."
        
        # Critical TODOs/FIXMEs (blocking issues)
        echo "ðŸ“‹ Checking for critical TODOs/FIXMEs..."
        if grep -r 'TODO.*CRITICAL\|FIXME.*URGENT' Sources/ --include='*.swift'; then
          echo "âŒ CRITICAL issues found that should block deployment"
          echo "CRITICAL_ISSUES=found" >> $GITHUB_ENV
        else
          echo "âœ… No critical TODOs/FIXMEs found"
          echo "CRITICAL_ISSUES=none" >> $GITHUB_ENV
        fi
        
        echo "âœ… Critical pattern analysis completed"
    
    - name: Code Smell Detection  
      run: |
        echo "ðŸ” Running code smell detection (moved from pre-commit)..."
        
        FORCE_UNWRAPS=0
        PRINT_STATEMENTS=0
        
        # Check for force unwraps in critical manager files
        echo "ðŸ“‹ Checking for force unwraps in manager files..."
        if grep -r "!" Sources/KeyPath/Managers/ --include="*.swift" | grep -v "!=" | grep -v "// swiftlint:disable" >/dev/null 2>&1; then
          echo "âš ï¸ Force unwraps found in manager files:"
          grep -r "!" Sources/KeyPath/Managers/ --include="*.swift" | grep -v "!=" | grep -v "// swiftlint:disable" | head -10
          FORCE_UNWRAPS=1
        else
          echo "âœ… No problematic force unwraps in manager files"
        fi
        
        # Check for print statements (should use Logger)
        echo "ðŸ“‹ Checking for print statements..."
        if grep -r "print(" Sources/ --include="*.swift" | grep -v "// debug" >/dev/null 2>&1; then
          echo "âš ï¸ print() statements found (consider using Logger):"
          grep -r "print(" Sources/ --include="*.swift" | grep -v "// debug" | head -10
          PRINT_STATEMENTS=1
        else
          echo "âœ… No print() statements found"
        fi
        
        # Store results for summary
        echo "FORCE_UNWRAPS=$FORCE_UNWRAPS" >> $GITHUB_ENV
        echo "PRINT_STATEMENTS=$PRINT_STATEMENTS" >> $GITHUB_ENV
        
        echo "âœ… Code smell detection completed"
    
    - name: Additional Code Quality
      run: |
        echo "ðŸ” Additional code quality checks..."
        
        # Check for general TODO/FIXME (informational)
        echo "ðŸ“‹ Checking for general TODO/FIXME comments..."
        if grep -r "TODO\|FIXME" Sources/ --include="*.swift" | head -10; then
          echo "â„¹ï¸ Found TODO/FIXME comments (informational)"
          echo "TODO_COMMENTS=found" >> $GITHUB_ENV
        else
          echo "âœ… No TODO/FIXME comments found" 
          echo "TODO_COMMENTS=none" >> $GITHUB_ENV
        fi
        
        echo "âœ… Additional quality checks completed"
    
    - name: Generate Code Quality Summary
      if: always()
      run: |
        echo "ðŸ“‹ Generating comprehensive code quality summary..."
        
        echo "## ðŸ” Code Quality Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # SwiftLint results
        echo "### ðŸ“‹ SwiftLint Analysis (moved from pre-commit)" >> $GITHUB_STEP_SUMMARY
        if [ "${SWIFTLINT_STATUS:-unknown}" = "passed" ]; then
          echo "âœ… **No SwiftLint violations found**" >> $GITHUB_STEP_SUMMARY
        elif [ "${SWIFTLINT_STATUS:-unknown}" = "issues_found" ]; then
          echo "âš ï¸ **SwiftLint issues detected** - See job logs for details" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ SwiftLint status unknown" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # SwiftFormat results
        echo "### ðŸ“ SwiftFormat Analysis" >> $GITHUB_STEP_SUMMARY
        echo "â„¹ï¸ Formatting check completed (pre-commit handles auto-fixes)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Critical patterns
        echo "### ðŸš¨ Critical Pattern Analysis (moved from pre-commit)" >> $GITHUB_STEP_SUMMARY
        if [ "${CRITICAL_ISSUES:-unknown}" = "none" ]; then
          echo "âœ… **No critical TODOs/FIXMEs found**" >> $GITHUB_STEP_SUMMARY
        elif [ "${CRITICAL_ISSUES:-unknown}" = "found" ]; then
          echo "âŒ **CRITICAL issues found** - Review urgently" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ Critical pattern status unknown" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Code smell detection
        echo "### ðŸ” Code Smell Detection (moved from pre-commit)" >> $GITHUB_STEP_SUMMARY
        SMELLS_FOUND=0
        if [ "${FORCE_UNWRAPS:-0}" = "1" ]; then
          echo "âš ï¸ Force unwraps found in manager files" >> $GITHUB_STEP_SUMMARY
          SMELLS_FOUND=1
        fi
        if [ "${PRINT_STATEMENTS:-0}" = "1" ]; then
          echo "âš ï¸ print() statements found (consider using Logger)" >> $GITHUB_STEP_SUMMARY 
          SMELLS_FOUND=1
        fi
        if [ "$SMELLS_FOUND" = "0" ]; then
          echo "âœ… **No code smells detected**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # General TODO/FIXME
        echo "### ðŸ“ General TODO/FIXME Comments" >> $GITHUB_STEP_SUMMARY
        if [ "${TODO_COMMENTS:-unknown}" = "none" ]; then
          echo "âœ… No TODO/FIXME comments found" >> $GITHUB_STEP_SUMMARY
        elif [ "${TODO_COMMENTS:-unknown}" = "found" ]; then
          echo "â„¹ï¸ TODO/FIXME comments present (informational)" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Pre-commit vs CI Responsibilities" >> $GITHUB_STEP_SUMMARY
        echo "- **Pre-commit:** SwiftFormat + SwiftLint auto-fixes only" >> $GITHUB_STEP_SUMMARY 
        echo "- **CI:** Comprehensive analysis, reporting, and quality gates" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Most checks are informational and do not block CI*" >> $GITHUB_STEP_SUMMARY
    - name: Install lcov (for HTML coverage)
      if: always()
      run: |
        if ! command -v genhtml >/dev/null 2>&1; then
          echo "ðŸ“¦ Installing lcov for HTML coverage..."
          brew install lcov
        fi
