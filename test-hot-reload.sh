#!/bin/bash

# Hot Reload Integration Test
# Tests that configuration changes are detected and applied automatically

set -e

echo "ğŸ”„ Running hot reload integration tests..."

# Configuration
CONFIG_PATH="/Users/malpern/.config/keypath/keypath.kbd"
BACKUP_PATH="${CONFIG_PATH}.backup"
TEST_LOG="/tmp/hot-reload-test.log"

# Test mappings
ORIGINAL_MAPPING="caps -> esc"
TEST_MAPPING="1 -> 2"

cleanup() {
    echo "ğŸ§¹ Cleaning up test..."
    if [ -f "$BACKUP_PATH" ]; then
        mv "$BACKUP_PATH" "$CONFIG_PATH"
        echo "âœ… Original configuration restored"
    fi
    rm -f "$TEST_LOG"
}

trap cleanup EXIT

echo "ğŸ“‹ Test Setup:"
echo "  Config path: $CONFIG_PATH"
echo "  Current mapping: $ORIGINAL_MAPPING"
echo "  Test mapping: $TEST_MAPPING"
echo ""

# Step 1: Verify Kanata service is running
echo "ğŸ” Step 1: Checking Kanata service status..."
if ! pgrep -f "kanata.*--cfg.*keypath.kbd" > /dev/null; then
    echo "âŒ Kanata service not running with KeyPath config"
    exit 1
fi
echo "âœ… Kanata service is running"

# Step 2: Verify TCP server is responding
echo "ğŸ” Step 2: Checking TCP server connectivity..."
if ! echo "RequestLayerNames" | nc -w 2 127.0.0.1 54141 > /dev/null 2>&1; then
    echo "âŒ TCP server not responding on port 54141"
    exit 1
fi
echo "âœ… TCP server is responding"

# Step 3: Backup current configuration
echo "ğŸ” Step 3: Backing up current configuration..."
cp "$CONFIG_PATH" "$BACKUP_PATH"
echo "âœ… Configuration backed up"

# Step 4: Get baseline log position
echo "ğŸ” Step 4: Getting baseline log position..."
BASELINE_LOG_SIZE=$(wc -c < /var/log/kanata.log 2>/dev/null || echo "0")
echo "ğŸ“Š Baseline log size: $BASELINE_LOG_SIZE bytes"

# Step 5: Generate test configuration
echo "ğŸ” Step 5: Creating test configuration..."
cat > "$CONFIG_PATH" << EOF
;; Generated by KeyPath Hot Reload Test
;; Test mapping: $TEST_MAPPING
;;
;; SAFETY FEATURES:
;; - process-unmapped-keys no: Only process explicitly mapped keys

(defcfg
  process-unmapped-keys no
)

(defsrc
  1
)

(deflayer base
  2
)
EOF

echo "âœ… Test configuration written"

# Step 6: Wait for hot reload detection
echo "ğŸ” Step 6: Waiting for hot reload detection..."
echo "â±ï¸  Monitoring for configuration reload (10 second timeout)..."

# Monitor for reload indicators
RELOAD_DETECTED=false
for i in {1..10}; do
    sleep 1
    
    # Check if log size increased (indicates reload activity)
    CURRENT_LOG_SIZE=$(wc -c < /var/log/kanata.log 2>/dev/null || echo "0")
    if [ "$CURRENT_LOG_SIZE" -gt "$BASELINE_LOG_SIZE" ]; then
        echo "ğŸ“ˆ Log activity detected (size: $CURRENT_LOG_SIZE bytes)"
        RELOAD_DETECTED=true
        break
    fi
    
    echo -n "."
done
echo ""

if [ "$RELOAD_DETECTED" = "true" ]; then
    echo "âœ… Hot reload activity detected"
else
    echo "âš ï¸  No reload activity detected in logs"
fi

# Step 7: Verify service is still running
echo "ğŸ” Step 7: Verifying service stability..."
sleep 2

if pgrep -f "kanata.*--cfg.*keypath.kbd" > /dev/null; then
    echo "âœ… Kanata service still running after configuration change"
else
    echo "âŒ Kanata service stopped after configuration change"
    exit 1
fi

# Step 8: Verify TCP server still responding
echo "ğŸ” Step 8: Verifying TCP server functionality..."
if echo "RequestLayerNames" | nc -w 2 127.0.0.1 54141 > /dev/null 2>&1; then
    echo "âœ… TCP server still responding after reload"
else
    echo "âŒ TCP server not responding after reload"
    exit 1
fi

# Step 9: Check recent log entries for reload confirmation
echo "ğŸ” Step 9: Analyzing reload logs..."
if tail -20 /var/log/kanata.log 2>/dev/null | grep -q "main.*Loading config"; then
    echo "âœ… Configuration reload confirmed in logs"
elif tail -20 /var/log/kanata.log 2>/dev/null | grep -q "cfg"; then
    echo "âš ï¸  Configuration-related activity detected"
else
    echo "âš ï¸  No explicit reload confirmation in recent logs"
fi

# Summary
echo ""
echo "ğŸ‰ Hot Reload Test Results:"
echo "  âœ… Service stability: PASS"
echo "  âœ… TCP server: PASS"
if [ "$RELOAD_DETECTED" = "true" ]; then
    echo "  âœ… Reload detection: PASS"
else
    echo "  âš ï¸  Reload detection: INCONCLUSIVE"
fi

echo ""
echo "ğŸ Hot reload test completed successfully!"
echo "ğŸ“ Note: Original configuration will be restored automatically"