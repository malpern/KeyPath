# Kanata --watch Flag Bug Report

## Summary
The `--watch` flag in Kanata detects configuration file changes and logs reload attempts, but fails to actually reload the key mappings until a full service restart is performed.

## Environment
- **Kanata Version**: Latest (as of 2025-08-10)
- **Platform**: macOS 14.5 (Darwin 24.5.0)
- **Installation**: Homebrew (`/usr/local/bin/kanata`)
- **Service Management**: macOS LaunchDaemon (`com.keypath.kanata`)

## Configuration
**LaunchDaemon Command:**
```bash
/usr/local/bin/kanata --cfg /Users/malpern/.config/keypath/keypath.kbd --watch --debug --log-layer-changes
```

**Config File Location:**
```
/Users/malpern/.config/keypath/keypath.kbd
```

**Sample Configuration:**
```lisp
;; Generated by KeyPath
;; Test config with new ~/.config/keypath location - CONFIRMED HOT RELOAD WORKING!
;;
;; SAFETY FEATURES:
;; - process-unmapped-keys no: Only process explicitly mapped keys

(defcfg
  process-unmapped-keys no
)

(defsrc
  caps tab 1 2 5
)

(deflayer base
  esc lctl 2 3 6
)
```

## Bug Reproduction Steps

1. Start Kanata service with `--watch` flag
2. Verify service is running: `pgrep -fl kanata`
3. Test initial mappings work (e.g., caps→esc)
4. Modify configuration file (add new mapping, e.g., 5→6)
5. Monitor logs: `tail -f /var/log/kanata.log`
6. Test new mapping (press "5" key)

## Expected Behavior
- Kanata should detect file change
- Kanata should reload configuration
- New mappings should work immediately without restart

## Actual Behavior

### What Works ✅
- File change detection: Logs show `Config file changed: /path/to/config.kbd, triggering reload`
- Reload attempt logging: Logs show `Requested live reload of file: /path/to/config.kbd`
- Service continues running without crashes

### What Fails ❌  
- **Key mappings don't update**: Old mappings continue working, new mappings are ignored
- **Requires full restart**: Only `launchctl kickstart -k system/com.keypath.kanata` makes new mappings active

## Test Results

| Test | Config Change | Hot Reload Works | Manual Restart Works |
|------|---------------|------------------|---------------------|
| 1    | caps→esc, tab→lctl | ✅ (initial)   | ✅                  |
| 2    | Add 1→2        | ❌               | ✅                  |  
| 3    | Add 2→3        | ❌               | ✅                  |
| 4    | Add 5→6        | ❌               | ✅                  |

## Log Evidence

**File Change Detection (Working):**
```
21:28:16.8663 [INFO] Config file changed: /Users/malpern/.config/keypath/keypath.kbd, triggering reload
21:28:16.8664 [INFO] Requested live reload of file: /Users/malpern/.config/keypath/keypath.kbd
```

**No Error Messages:**
- No parse errors in logs
- No permission errors  
- No file access errors
- Service remains stable

## Debugging Hypothesis

The bug appears to be in Kanata's configuration reload mechanism:

1. **File watching works**: inotify/fsevents properly detect changes
2. **Config parsing works**: No parse errors in logs  
3. **Reload trigger works**: Logs confirm reload attempt
4. **Key mapping update fails**: The internal key mapping state doesn't refresh

Possible root causes:
- State machine not properly reinitializing after reload
- Key mapping cache not being cleared
- Event handler registration not being updated
- Race condition between file detection and config application

## Workaround

For reliable configuration updates:
1. Use manual service restart: `launchctl kickstart -k system/com.keypath.kanata`
2. Or implement automatic restart in application code when config changes
3. Don't rely on `--watch` for production deployments

## Additional Notes

- Bug is consistent and reproducible
- Affects all types of key mappings (simple, modifier, number keys)  
- No memory leaks or performance issues observed
- Bug persists across multiple file modification methods (editor save, programmatic write)

## Investigation Recommendations

1. **Code Review**: Focus on config reload logic in Kanata source
2. **Debug Logging**: Add more granular logging to reload process
3. **State Inspection**: Verify internal key mapping state before/after reload
4. **Platform Testing**: Test on Linux to see if macOS-specific issue

---

*Report generated 2025-08-10 during KeyPath integration testing*