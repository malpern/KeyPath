# Kanata Hot Reload Regression Report

## Summary
Hot reload regression: Despite previous fix, reload mechanism is again getting stuck and not completing successfully.

## Environment
- **Kanata Version**: Latest (post-v1.9.0 with supposed hot reload fix)
- **Platform**: macOS (Darwin 24.5.0) 
- **Architecture**: arm64 (Apple Silicon)
- **Installation**: Homebrew
- **Launch Method**: LaunchDaemon via launchctl

## Regression Details

### Expected Behavior (What the fix was supposed to achieve)
1. File watcher detects config changes
2. Reload is triggered with "Requested live reload" message
3. **Reload completes with "Live reload successful" message**
4. New mappings become active immediately

### Current Broken Behavior (Regression)
1. ✅ File watcher detects changes correctly
2. ✅ Reload is triggered with "Requested live reload" message  
3. ❌ **Reload never completes - no "Live reload successful" message**
4. ❌ **Mappings remain unchanged, old config still active**

## Evidence

### Config File Contains Valid 1→2 Mapping
```lisp
;; Generated by KeyPath
;; Mappings: caps -> esc, 1 -> 2

(defcfg
  process-unmapped-keys no
)

(defsrc
  caps 1
)

(deflayer base
  esc 2
)
```

### Log Evidence Shows Stuck Reload

**File Detection Works:**
```
16:30:36.7034 [DEBUG] File watcher event received: Any for path: /Users/malpern/.config/keypath/keypath.kbd
16:30:36.7046 [INFO] Config file changed: /Users/malpern/.config/keypath/keypath.kbd (event: Any), triggering reload
16:30:36.7047 [INFO] Requested live reload of file: /Users/malpern/.config/keypath/keypath.kbd
```

**Reload Never Completes:**
```
16:31:37.3831 [DEBUG] KeyEvent { code: KEY_1 (2), value: Press } is not mapped
```

**Second Attempt Also Fails:**
```
16:31:52.5327 [INFO] Config file changed: /Users/malpern/.config/keypath/keypath.kbd (event: Any), triggering reload
16:31:52.5328 [INFO] Requested live reload of file: /Users/malpern/.config/keypath/keypath.kbd
16:32:03.3041 [DEBUG] KeyEvent { code: KEY_1 (2), value: Press } is not mapped
```

### Missing Success Messages
The logs show **no "Live reload successful"** messages despite multiple reload attempts.

## Impact

### Regression Severity: Critical
- **Previous fix did not hold** - hot reload broken again
- **User experience degraded** - config changes don't apply
- **Development workflow broken** - manual restarts required for every change
- **Trust in stability reduced** - fixes are not persistent

## Test Case to Verify Fix

```bash
# 1. Start Kanata with watch
/usr/local/bin/kanata --cfg config.kbd --watch --debug --log-layer-changes

# 2. Create simple config with 1→2 mapping
# 3. Modify config file (add/remove mappings)  
# 4. Verify in logs:
#    - "Config file changed" appears ✅
#    - "Requested live reload" appears ✅  
#    - "Live reload successful" appears ❌ MISSING
#    - Test key "1" - should output "2" ❌ FAILS

# 5. Expected: All steps pass, mapping works immediately
# 6. Actual: Reload gets stuck, mapping never activates
```

## Comparison with Previous Working State

**Before Regression (Expected):**
```
[INFO] Config file changed: config.kbd, triggering reload
[INFO] Requested live reload of file: config.kbd  
[INFO] Live reload successful ← THIS MESSAGE IS MISSING
```

**Current Broken State:**
```
[INFO] Config file changed: config.kbd, triggering reload
[INFO] Requested live reload of file: config.kbd
[no completion message - reload stuck]
```

## Request for Kanata Team

1. **Investigate regression** - What changed since the hot reload fix?
2. **Add comprehensive reload testing** to prevent future regressions
3. **Implement timeout mechanism** - Force reload completion or clear stuck state
4. **Improve error logging** - Show why reload fails to complete
5. **Add reload status endpoint** - Allow external monitoring of reload state

## Reproduction Steps

1. Start: `kanata --cfg config.kbd --watch --debug`
2. Create config with any key mapping (e.g., 1→2)
3. Save config file (triggers file watcher)
4. Check logs: "Requested live reload" appears but no "successful" message
5. Test mapping: Original config still active, new mapping not working
6. Repeat: All subsequent changes show same stuck behavior

**Result**: Hot reload mechanism completely non-functional despite supposed fix.

---

**Reporter**: KeyPath Development Team  
**Date**: August 15, 2025  
**Status**: REGRESSION - Previously reported as fixed but issue has returned