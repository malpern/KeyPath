<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InstallerEngine Fa√ßade Design</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --sf-blue: #007AFF;
            --sf-gray: #8E8E93;
            --sf-light-gray: #F2F2F7;
            --sf-border: #E5E5EA;
            --sf-text: #1D1D1F;
            --sf-secondary: #86868B;
            --sf-green: #34C759;
            --sf-orange: #FF9500;
            --sf-red: #FF3B30;
            --sf-purple: #AF52DE;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: var(--sf-text);
            background: #ffffff;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
            padding: 60px 20px;
        }

        /* Hero Section */
        .hero {
            text-align: center;
            padding: 80px 0 60px;
            background: linear-gradient(180deg, var(--sf-light-gray) 0%, #ffffff 100%);
            margin: -60px -20px 60px;
            border-radius: 0 0 30px 30px;
        }

        .hero-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: var(--sf-blue);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        h1 {
            font-size: 48px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 16px;
            color: var(--sf-text);
        }

        .subtitle {
            font-size: 21px;
            color: var(--sf-secondary);
            font-weight: 400;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Section Headers */
        h2 {
            font-size: 36px;
            font-weight: 700;
            margin: 60px 0 24px;
            letter-spacing: -0.3px;
        }

        h3 {
            font-size: 28px;
            font-weight: 600;
            margin: 40px 0 20px;
            letter-spacing: -0.2px;
        }

        h4 {
            font-size: 21px;
            font-weight: 600;
            margin: 28px 0 12px;
            color: var(--sf-text);
        }

        p {
            font-size: 17px;
            line-height: 1.7;
            color: var(--sf-text);
            margin-bottom: 16px;
        }

        /* Cards */
        .card {
            background: #ffffff;
            border: 1px solid var(--sf-border);
            border-radius: 16px;
            padding: 32px;
            margin: 24px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 32px 0;
        }

        .card-small {
            background: var(--sf-light-gray);
            border-radius: 12px;
            padding: 24px;
            transition: transform 0.2s ease;
        }

        .card-small:hover {
            transform: translateY(-2px);
        }

        .card-icon {
            font-size: 32px;
            margin-bottom: 12px;
            display: block;
        }

        .card-title {
            font-size: 19px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .card-description {
            font-size: 15px;
            color: var(--sf-secondary);
            line-height: 1.5;
        }

        /* API Methods */
        .method {
            background: #ffffff;
            border-left: 4px solid var(--sf-blue);
            padding: 24px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        }

        .method-signature {
            font-family: 'SF Mono', Monaco, Courier, monospace;
            font-size: 15px;
            color: var(--sf-purple);
            background: var(--sf-light-gray);
            padding: 12px 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
        }

        .method-label {
            display: inline-block;
            background: var(--sf-blue);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Lists */
        ul, ol {
            margin: 16px 0 16px 24px;
            font-size: 17px;
        }

        li {
            margin: 8px 0;
            padding-left: 8px;
        }

        ul li::marker {
            color: var(--sf-blue);
        }

        /* Code */
        code {
            font-family: 'SF Mono', Monaco, Courier, monospace;
            font-size: 15px;
            background: var(--sf-light-gray);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--sf-purple);
        }

        /* Workflow Diagram */
        .workflow {
            background: var(--sf-light-gray);
            border-radius: 16px;
            padding: 40px;
            margin: 40px 0;
        }

        .workflow-steps {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .workflow-step {
            background: white;
            border-radius: 12px;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        .step-number {
            background: var(--sf-blue);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .step-description {
            font-size: 15px;
            color: var(--sf-secondary);
        }

        .step-arrow {
            text-align: center;
            color: var(--sf-gray);
            font-size: 24px;
            margin: -8px 0;
        }

        /* Data Types */
        .type-list {
            display: grid;
            gap: 16px;
            margin: 24px 0;
        }

        .type-item {
            background: white;
            border: 1px solid var(--sf-border);
            border-radius: 10px;
            padding: 20px;
        }

        .type-name {
            font-family: 'SF Mono', Monaco, Courier, monospace;
            font-size: 17px;
            font-weight: 600;
            color: var(--sf-purple);
            margin-bottom: 8px;
        }

        .type-badge {
            display: inline-block;
            background: var(--sf-light-gray);
            color: var(--sf-secondary);
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 8px;
            text-transform: uppercase;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .badge-input { background: #E3F2FD; color: #1976D2; }
        .badge-output { background: #E8F5E9; color: #388E3C; }
        .badge-planning { background: #FFF3E0; color: #F57C00; }

        /* Callouts */
        .callout {
            background: var(--sf-light-gray);
            border-left: 4px solid var(--sf-blue);
            border-radius: 8px;
            padding: 20px 24px;
            margin: 24px 0;
        }

        .callout-title {
            font-weight: 600;
            font-size: 17px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .callout-icon {
            font-size: 20px;
        }

        /* Flow Diagram */
        .flow-diagram {
            background: white;
            border: 1px solid var(--sf-border);
            border-radius: 16px;
            padding: 40px;
            margin: 40px 0;
            overflow-x: auto;
        }

        .flow-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 16px 0;
            flex-wrap: nowrap;
        }

        .flow-box {
            background: var(--sf-blue);
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            text-align: center;
            min-width: 160px;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .flow-box.context { background: var(--sf-purple); box-shadow: 0 2px 8px rgba(175, 82, 222, 0.3); }
        .flow-box.check { background: var(--sf-orange); box-shadow: 0 2px 8px rgba(255, 149, 0, 0.3); }
        .flow-box.plan { background: var(--sf-green); box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3); }
        .flow-box.report { background: var(--sf-red); box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3); }

        .flow-arrow {
            font-size: 24px;
            color: var(--sf-gray);
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 80px;
            padding-top: 40px;
            border-top: 1px solid var(--sf-border);
            color: var(--sf-secondary);
            font-size: 15px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 36px; }
            h2 { font-size: 28px; }
            h3 { font-size: 22px; }
            .container { padding: 40px 16px; }
            .hero { padding: 60px 20px 40px; margin: -40px -16px 40px; }
            .card { padding: 24px; }
            .card-grid { grid-template-columns: 1fr; }
            .flow-row { flex-direction: column; }
            .flow-arrow { transform: rotate(90deg); }
        }

        /* Print Styles */
        @media print {
            body { background: white; }
            .hero { background: white; }
            .card, .method, .type-item { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <div class="hero-icon">‚öôÔ∏è</div>
            <h1>InstallerEngine Fa√ßade</h1>
            <p class="subtitle">A unified interface for managing KeyPath's LaunchDaemon services with simplicity and precision.</p>
        </div>

        <!-- Overview -->
        <section id="overview">
            <h2>Overview</h2>
            <p>The <code>InstallerEngine</code> provides a simple, consistent fa√ßade for installing, repairing, and managing KeyPath's LaunchDaemon services. It serves as a single point of entry for CLI tools, GUI applications, and functional tests‚Äîeliminating the need to understand the underlying LaunchDaemon infrastructure.</p>
        </section>

        <!-- Design Goals -->
        <section id="goals">
            <h2>Design Goals</h2>
            
            <div class="card-grid">
                <div class="card-small">
                    <span class="card-icon">üéØ</span>
                    <div class="card-title">Single Point of Entry</div>
                    <div class="card-description">One fa√ßade that any caller can use without re-learning the entire stack</div>
                </div>
                
                <div class="card-small">
                    <span class="card-icon">üåâ</span>
                    <div class="card-title">Bridge Existing Behavior</div>
                    <div class="card-description">Design grounded in current implementation for clear before/after validation</div>
                </div>
            </div>

            <h3>Core Responsibilities</h3>
            
            <div class="card">
                <h4>üîç Service Detection & Health Monitoring</h4>
                <ul>
                    <li>Detect LaunchDaemon and SMAppService state, health status, and config paths</li>
                    <li>Leverage existing <code>getServiceStatus()</code> and test assertions</li>
                </ul>
            </div>

            <div class="card">
                <h4>üì¶ Service Installation & Management</h4>
                <ul>
                    <li>Generate service definitions (plist templates, user configs)</li>
                    <li>Install services idempotently</li>
                    <li>Handle "missing plist triggers reinstall" scenarios</li>
                </ul>
            </div>

            <div class="card">
                <h4>üîß Service Maintenance</h4>
                <ul>
                    <li>Load, restart, and repair unhealthy or missing services</li>
                    <li>Execute automated repair flows</li>
                </ul>
            </div>

            <div class="card">
                <h4>üìä Version Management</h4>
                <ul>
                    <li>Understand Kanata binary versions and migrate configs</li>
                    <li>Handle upgrade checks and config migrations</li>
                </ul>
            </div>

            <div class="card">
                <h4>üîê Privilege Escalation</h4>
                <ul>
                    <li>Acquire admin privileges through helper, AuthorizationServices, or osascript</li>
                    <li>Execute privileged operations safely</li>
                </ul>
            </div>

            <div class="card">
                <h4>üéõÔ∏è SMAppService Integration</h4>
                <ul>
                    <li>Register and monitor SMAppService status for Kanata background items</li>
                    <li>Handle enabled/pending/failure states</li>
                </ul>
            </div>

            <div class="card">
                <h4>üìà Observability</h4>
                <ul>
                    <li>Emit structured reports and logs for UI and test consumption</li>
                    <li>Install supporting services like log rotation</li>
                </ul>
            </div>
        </section>

        <!-- Public API -->
        <section id="api">
            <h2>Public API</h2>
            <p>The fa√ßade exposes four primary methods that follow a natural workflow:</p>

            <div class="flow-diagram">
                <div class="flow-row">
                    <div class="flow-box">snapshotSystem()</div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-box check">checkRequirements()</div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-box plan">makePlan()</div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-box report">run()</div>
                </div>
            </div>

            <div class="method">
                <span class="method-label">Method 1</span>
                <h4>snapshotSystem()</h4>
                <div class="method-signature">func snapshotSystem() -> SystemContext</div>
                <p><strong>Purpose:</strong> Capture current system state</p>
                <p><strong>Returns:</strong> Read-only snapshot of service states, file/permission status, and helper availability</p>
                <p><strong>Use this to:</strong></p>
                <ul>
                    <li>Render current status in UI</li>
                    <li>Decide what actions are needed</li>
                    <li>Provide context for planning</li>
                </ul>
            </div>

            <div class="method">
                <span class="method-label">Method 2</span>
                <h4>checkRequirements()</h4>
                <div class="method-signature">func checkRequirements(_ requirements: [Requirement], in context: SystemContext) -> RequirementCheck</div>
                <p><strong>Purpose:</strong> Validate prerequisites before installation</p>
                <p><strong>Returns:</strong> Pass/fail status for each requirement with explanatory hints</p>
                <p><strong>Evaluates conditions such as:</strong></p>
                <ul>
                    <li>Admin rights availability</li>
                    <li>Writable <code>/Library/LaunchDaemons</code> directory</li>
                    <li>SMAppService approval status</li>
                    <li>Helper registration state</li>
                </ul>
            </div>

            <div class="method">
                <span class="method-label">Convenience</span>
                <h4>checkAllRequirements()</h4>
                <div class="method-signature">func checkAllRequirements(in context: SystemContext) -> RequirementCheck</div>
                <p><strong>Purpose:</strong> Check standard requirements without manually building the array</p>
                <p>Uses a default list for typical install/repair flows. Expert callers can still use <code>checkRequirements(_:in:)</code> for custom requirement sets.</p>
            </div>

            <div class="method">
                <span class="method-label">Method 3</span>
                <h4>makePlan()</h4>
                <div class="method-signature">func makePlan(for intent: InstallIntent, context: SystemContext) -> InstallPlan</div>
                <p><strong>Purpose:</strong> Create an execution plan without running it</p>
                <p><strong>Returns:</strong> Ordered list of operations tailored to the observed context</p>
                <p><strong>Converts intents into:</strong></p>
                <ul>
                    <li>Required <code>ServiceRecipe</code>s</li>
                    <li>Privileged operations</li>
                    <li>Configuration updates</li>
                    <li>Health check steps</li>
                </ul>
                <div class="callout">
                    <div class="callout-title"><span class="callout-icon">üí°</span> Supported Intents</div>
                    <div class="card-description"><code>.install</code>, <code>.repair</code>, <code>.uninstall</code>, <code>.inspectOnly</code></div>
                </div>
            </div>

            <div class="method">
                <span class="method-label">Method 4</span>
                <h4>run()</h4>
                <div class="method-signature">func run(plan: InstallPlan, broker: PrivilegeBroker) -> InstallerReport</div>
                <p><strong>Purpose:</strong> Execute the planned operations</p>
                <p><strong>Returns:</strong> Structured report with success/failure details and final state</p>
                <p><strong>Performs actions such as:</strong></p>
                <ul>
                    <li>Copy plists to system directories</li>
                    <li>Bootstrap LaunchDaemons</li>
                    <li>Restart unhealthy services</li>
                    <li>Install log rotation</li>
                    <li>Register SMAppService items</li>
                </ul>
            </div>

            <div class="method">
                <span class="method-label">Convenience</span>
                <h4>install() / repair()</h4>
                <div class="method-signature">func install(using broker: PrivilegeBroker) -> InstallerReport</div>
                <div class="method-signature">func repair(using broker: PrivilegeBroker) -> InstallerReport</div>
                <p><strong>Purpose:</strong> One-shot helpers that run the full pipeline</p>
                <p>Orchestrates snapshot ‚Üí check ‚Üí plan ‚Üí run internally. Reduces boilerplate for CLI and simple GUI code while keeping the full pipeline available for complex flows.</p>
            </div>
        </section>

        <!-- Data Types -->
        <section id="types">
            <h2>Core Data Types</h2>

            <h3>Input Types</h3>
            <div class="type-list">
                <div class="type-item">
                    <div class="type-name">SystemContext<span class="type-badge">input</span></div>
                    <p>Snapshot of detected system state including:</p>
                    <ul>
                        <li>Service status (running, stopped, missing)</li>
                        <li>SMAppService state</li>
                        <li>Filesystem permissions</li>
                        <li>Helper availability</li>
                    </ul>
                    <p><em>Note: Watch for god-struct during implementation. Consider splitting into sub-views (ServiceContext, PermissionsContext) if needed.</em></p>
                </div>

                <div class="type-item">
                    <div class="type-name">InstallIntent<span class="type-badge">input</span></div>
                    <p>Declarative enum describing the desired action:</p>
                    <ul>
                        <li><code>.install</code> ‚Äì Fresh installation</li>
                        <li><code>.repair</code> ‚Äì Fix broken/unhealthy services</li>
                        <li><code>.uninstall</code> ‚Äì Remove services</li>
                        <li><code>.inspectOnly</code> ‚Äì Detect without changes</li>
                    </ul>
                </div>

                <div class="type-item">
                    <div class="type-name">Requirement<span class="type-badge">input</span></div>
                    <p>Named precondition that must be satisfied:</p>
                    <ul>
                        <li>"Writable LaunchDaemons directory"</li>
                        <li>"Helper registered"</li>
                        <li>"Admin privileges available"</li>
                        <li>"SMAppService approved"</li>
                    </ul>
                </div>

                <div class="type-item">
                    <div class="type-name">PrivilegeBroker<span class="type-badge">input</span></div>
                    <p>Describes how privileged commands will execute:</p>
                    <ul>
                        <li>Helper IPC</li>
                        <li>Authorization Services</li>
                        <li>Test stubs</li>
                        <li>Legacy osascript</li>
                    </ul>
                </div>
            </div>

            <h3>Output Types</h3>
            <div class="type-list">
                <div class="type-item">
                    <div class="type-name">RequirementCheck<span class="type-badge">output</span></div>
                    <p>Maps each <code>Requirement</code> to:</p>
                    <ul>
                        <li>Pass/fail status</li>
                        <li>Missing information indicators</li>
                        <li>User-facing hints and remediation steps</li>
                    </ul>
                </div>

                <div class="type-item">
                    <div class="type-name">InstallerReport<span class="type-badge">output</span></div>
                    <p>Comprehensive execution summary:</p>
                    <ul>
                        <li>What operations ran</li>
                        <li>Success/failure status</li>
                        <li>Timestamps and duration</li>
                        <li>Final <code>SystemContext</code></li>
                        <li>Error details with recovery suggestions</li>
                    </ul>
                </div>
            </div>

            <h3>Planning Artifacts</h3>
            <div class="type-list">
                <div class="type-item">
                    <div class="type-name">InstallPlan<span class="type-badge">planning</span></div>
                    <p>Ordered collection of operations:</p>
                    <ul>
                        <li>Service recipes to apply</li>
                        <li>Supplemental steps (log rotation, config writes)</li>
                        <li>Dependencies and ordering constraints</li>
                    </ul>
                </div>

                <div class="type-item">
                    <div class="type-name">ServiceRecipe<span class="type-badge">planning</span></div>
                    <p>Complete specification for a single service:</p>
                    <ul>
                        <li>Plist content</li>
                        <li>Launchctl actions</li>
                        <li>Health check criteria</li>
                        <li>Version requirements</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Workflow -->
        <section id="workflow">
            <h2>Typical Workflow</h2>

            <div class="workflow">
                <div class="workflow-steps">
                    <div class="workflow-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <div class="step-title">Create Engine & Snapshot</div>
                            <div class="step-description">Caller creates InstallerEngine and calls snapshotSystem() ‚Üí SystemContext</div>
                        </div>
                    </div>
                    <div class="step-arrow">‚Üì</div>

                    <div class="workflow-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <div class="step-title">Check Requirements</div>
                            <div class="step-description">Call checkRequirements([...], context) ‚Üí RequirementCheck</div>
                        </div>
                    </div>
                    <div class="step-arrow">‚Üì</div>

                    <div class="workflow-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <div class="step-title">Validate Prerequisites</div>
                            <div class="step-description">If requirements fail ‚Üí surface errors and exit. Otherwise continue.</div>
                        </div>
                    </div>
                    <div class="step-arrow">‚Üì</div>

                    <div class="workflow-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <div class="step-title">Choose Intent & Plan</div>
                            <div class="step-description">Choose InstallIntent (e.g., .repair) and call makePlan(intent, context) ‚Üí InstallPlan</div>
                        </div>
                    </div>
                    <div class="step-arrow">‚Üì</div>

                    <div class="workflow-step">
                        <div class="step-number">5</div>
                        <div class="step-content">
                            <div class="step-title">Optional: Inspect Plan</div>
                            <div class="step-description">Inspect/validate plan (useful for tests and dry-run mode)</div>
                        </div>
                    </div>
                    <div class="step-arrow">‚Üì</div>

                    <div class="workflow-step">
                        <div class="step-number">6</div>
                        <div class="step-content">
                            <div class="step-title">Prepare Privilege Broker</div>
                            <div class="step-description">Create PrivilegeBroker (helper IPC, Authorization Services, or test stub)</div>
                        </div>
                    </div>
                    <div class="step-arrow">‚Üì</div>

                    <div class="workflow-step">
                        <div class="step-number">7</div>
                        <div class="step-content">
                            <div class="step-title">Execute Plan</div>
                            <div class="step-description">Call run(plan, broker) ‚Üí InstallerReport</div>
                        </div>
                    </div>
                    <div class="step-arrow">‚Üì</div>

                    <div class="workflow-step">
                        <div class="step-number">8</div>
                        <div class="step-content">
                            <div class="step-title">Check Results</div>
                            <div class="step-description">Report includes success/failure status and final SystemContext</div>
                        </div>
                    </div>
                    <div class="step-arrow">‚Üì</div>

                    <div class="workflow-step">
                        <div class="step-number">9</div>
                        <div class="step-content">
                            <div class="step-title">Optional: Verify State</div>
                            <div class="step-description">Call snapshotSystem() again to verify final state and ensure idempotence</div>
                        </div>
                    </div>
                </div>
            </div>

            <h3>Advanced Scenarios</h3>

            <div class="card">
                <h4>üîç Dry Run Mode</h4>
                <p>CLI can generate a plan and print it without calling <code>run()</code>, useful for:</p>
                <ul>
                    <li>Previewing changes</li>
                    <li>Debugging issues</li>
                    <li>Documentation</li>
                </ul>
            </div>

            <div class="card">
                <h4>üîÑ Fix Button Flow</h4>
                <p>GUI can implement a "Fix" button that loops through the entire workflow:</p>
                <ol>
                    <li>Detect current state</li>
                    <li>Check requirements</li>
                    <li>Plan repair actions</li>
                    <li>Execute repair</li>
                    <li>Re-detect to show success</li>
                </ol>
            </div>

            <div class="card">
                <h4>‚ö†Ô∏è Failed Preconditions</h4>
                <p><strong>If <code>checkRequirements()</code> returns failures:</strong></p>
                <ul>
                    <li>Stop before planning/execution</li>
                    <li>Surface blocking items to user</li>
                    <li>Wait for manual resolution</li>
                </ul>
                <p><strong>If something fails mid-run:</strong></p>
                <ul>
                    <li><code>run()</code> reports failing step in <code>InstallerReport</code></li>
                    <li>UI/test decides: retry, prompt for intervention, or abort</li>
                </ul>
            </div>
        </section>

        <!-- Implementation Mapping -->
        <section id="implementation">
            <h2>Implementation Mapping</h2>
            <p>This section maps the fa√ßade design to existing code for implementation guidance.</p>

            <div class="card">
                <h4>Detection & Context</h4>
                <p><code>snapshotSystem()</code> wraps:</p>
                <ul>
                    <li><code>LaunchDaemonInstaller.getServiceStatus()</code></li>
                    <li><code>KanataDaemonManager.determineServiceManagementState()</code></li>
                    <li><code>ServiceStatusEvaluator</code> checks</li>
                    <li>Filesystem probes from <code>InstallerEngineFunctionalTests</code></li>
                </ul>
            </div>

            <div class="card">
                <h4>Validation</h4>
                <p><code>checkRequirements()</code> formalizes guards currently in:</p>
                <ul>
                    <li><code>createAllLaunchDaemonServices</code> (permission checks)</li>
                    <li><code>LogRotationTests</code> (privilege validation)</li>
                    <li><code>PrivilegedOperationsCoordinator.installServicesIfUninstalled</code></li>
                </ul>
            </div>

            <div class="card">
                <h4>Planning</h4>
                <p><code>InstallPlan</code> & <code>ServiceRecipe</code> capture logic from:</p>
                <ul>
                    <li><code>createAllLaunchDaemonServices</code></li>
                    <li><code>createConfigureAndLoadAllServices</code></li>
                    <li><code>restartUnhealthyServices</code></li>
                    <li>Config writing routines</li>
                    <li>Version checks (<code>shouldUpgradeKanata</code>)</li>
                    <li><code>installLogRotationService</code></li>
                </ul>
            </div>

            <div class="card">
                <h4>Execution</h4>
                <p><code>run(plan:broker:)</code> becomes fa√ßade over:</p>
                <ul>
                    <li><code>PrivilegedOperationsCoordinator</code></li>
                    <li>Helper vs AuthorizationServices execution paths</li>
                    <li><code>AdminCommandExecutorHolder</code></li>
                    <li>AppleScript fallbacks</li>
                </ul>
            </div>

            <div class="card">
                <h4>Privilege Handling</h4>
                <p><code>PrivilegeBroker</code> corresponds to:</p>
                <ul>
                    <li>Helper IPC (<code>HelperManager</code>)</li>
                    <li>Authorization Services path</li>
                    <li>Test overrides (<code>LaunchDaemonInstaller.authorizationScriptRunnerOverride</code>)</li>
                </ul>
            </div>

            <div class="card">
                <h4>Reporting</h4>
                <p><code>InstallerReport</code> extends:</p>
                <ul>
                    <li>Existing lightweight struct from <code>LaunchDaemonInstaller</code></li>
                    <li>Maintains logging/test continuity</li>
                    <li>Adds structured failure details</li>
                </ul>
            </div>
        </section>

        <!-- Design Principles -->
        <section id="principles">
            <h2>Design Principles & Tradeoffs</h2>

            <h3>Simplicity First</h3>

            <div class="callout">
                <div class="callout-title"><span class="callout-icon">‚ú®</span> Easy to Explain</div>
                <p>A junior Swift developer can understand the fa√ßade in minutes:</p>
                <ul>
                    <li><strong>Four methods:</strong> inspect ‚Üí check ‚Üí plan ‚Üí run</li>
                    <li><strong>Eight nouns:</strong> clear data flow through context/plan/report</li>
                </ul>
            </div>

            <div class="callout">
                <div class="callout-title"><span class="callout-icon">üéØ</span> No Over-Engineering</div>
                <ul>
                    <li>No protocols or generics added</li>
                    <li><code>PrivilegeBroker</code> is a plain value chosen at call time</li>
                    <li>Public surface is intentionally "boring"</li>
                </ul>
            </div>

            <h3>Incremental Migration</h3>

            <div class="card">
                <h4>üîå Pluggable Execution</h4>
                <p>Broker pattern allows:</p>
                <ul>
                    <li>Refactoring internals without changing fa√ßade</li>
                    <li>Multiple privilege paths coexist</li>
                    <li>Test doubles slip in easily</li>
                </ul>
            </div>

            <div class="card">
                <h4>üåâ Bridge to Existing Code</h4>
                <p>Design preserves current behavior:</p>
                <ul>
                    <li>Clear mapping from old to new</li>
                    <li>Tests validate equivalence</li>
                    <li>Can migrate incrementally</li>
                </ul>
            </div>

            <h3>Known Limitations</h3>

            <div class="callout" style="border-left-color: var(--sf-orange);">
                <div class="callout-title"><span class="callout-icon">‚ö†Ô∏è</span> Deferred Features</div>
                <p><strong>No Side Effects in Planning:</strong> <code>makePlan()</code> is pure (no I/O). All effects happen in <code>run()</code>. May need caching if detection is expensive.</p>
            </div>
        </section>

        <!-- Status -->
        <section id="status">
            <h2>Status</h2>
            <div class="callout" style="border-left-color: var(--sf-green);">
                <div class="callout-title"><span class="callout-icon">üìÑ</span> Design Specification</div>
                <p>No code changes were made. This is a design specification document.</p>
            </div>

            <h3>Next Steps</h3>
            <ol>
                <li>Review and approve fa√ßade design</li>
                <li>Implement core types</li>
                <li>Migrate existing callers incrementally</li>
                <li>Add comprehensive tests</li>
                <li>Update documentation</li>
            </ol>
        </section>

        <div class="footer">
            <p>KeyPath Project ‚Äî InstallerEngine Design Specification</p>
            <p>Generated November 16, 2025</p>
        </div>
    </div>
</body>
</html>
