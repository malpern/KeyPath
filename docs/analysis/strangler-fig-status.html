<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>KeyPath Service Layer Strangler Fig</title>
    <style>
        :root {
            color-scheme: light dark;
            --blue: #0071e3;
            --indigo: #5e5ce6;
            --teal: #30d158;
            --amber: #ffd60a;
            --orange: #ff9500;
            --gray: rgba(60, 60, 67, 0.6);
            --gray-text: rgba(60, 60, 67, 0.7);
            --panel: rgba(255, 255, 255, 0.7);
            --panel-dark: rgba(28, 28, 30, 0.65);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --gray: rgba(235, 235, 245, 0.6);
                --gray-text: rgba(235, 235, 245, 0.7);
            }
        }
        body {
            margin: 0;
            font-family: "SF Pro Display", "SF Pro Text", -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            color: #111;
            background: radial-gradient(circle at top, #f4f4f7 0%, #e2e6ee 40%, #d7dbea 80%);
            padding-bottom: 120px;
        }
        @media (prefers-color-scheme: dark) {
            body {
                color: #f5f5f7;
                background: radial-gradient(circle at top, #1c1c1e 0%, #0f0f10 40%, #09090b 80%);
            }
        }
        .hero {
            padding: 80px 8vw 60px;
            text-align: center;
        }
        h1 {
            font-size: clamp(2.5rem, 4vw, 4rem);
            margin-bottom: 0.5em;
        }
        .tagline {
            font-size: 1.25rem;
            color: var(--gray);
        }
        section {
            margin: 40px auto;
            width: min(1100px, 92vw);
            background: var(--panel);
            backdrop-filter: blur(18px);
            border-radius: 28px;
            padding: 36px 46px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.08);
        }
        @media (prefers-color-scheme: dark) {
            section {
                background: var(--panel-dark);
                box-shadow: 0 25px 60px rgba(0, 0, 0, 0.45);
            }
        }
        h2 {
            font-size: 1.75rem;
            margin-top: 0;
        }
        .grid {
            display: grid;
            gap: 24px;
        }
        @media (min-width: 900px) {
            .grid.two {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .grid.three {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
            .grid.four {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
        .card {
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }
        .metric {
            font-size: 2.25rem;
            font-weight: 600;
            color: var(--blue);
        }
        .metric.warning {
            color: var(--orange);
        }
        .metric-label {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.85rem;
            color: var(--gray);
        }
        .timeline {
            border-left: 3px solid var(--indigo);
            padding-left: 24px;
            margin-left: 10px;
        }
        .timeline-item {
            margin-bottom: 26px;
        }
        .timeline-item h3 {
            margin: 0 0 6px;
            font-size: 1.2rem;
        }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.07);
        }
        .pill.done {
            background: rgba(48, 209, 88, 0.15);
            color: var(--teal);
        }
        .pill.next {
            background: rgba(0, 113, 227, 0.15);
            color: var(--blue);
        }
        .pill.risk {
            background: rgba(255, 214, 10, 0.18);
            color: var(--amber);
        }
        .pill.pending {
            background: rgba(255, 149, 0, 0.18);
            color: var(--orange);
        }
        .pill.partial {
            background: rgba(94, 92, 230, 0.15);
            color: var(--indigo);
        }
        .diagram {
            margin: 30px auto;
            border-radius: 24px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(0, 113, 227, 0.15), rgba(94, 92, 230, 0.15));
        }
        .diagram svg {
            width: 100%;
            height: auto;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th,
        .table td {
            text-align: left;
            padding: 14px 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }
        .table th {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-size: 0.85rem;
            color: var(--gray);
        }
        .effort {
            font-weight: 600;
            color: var(--indigo);
        }
        footer {
            text-align: center;
            color: var(--gray);
            margin-top: 60px;
            font-size: 0.95rem;
        }
        .status-banner {
            text-align: center;
            margin-top: 40px;
            padding: 30px;
            border-radius: 20px;
        }
        .status-banner.partial {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.25), rgba(255, 214, 10, 0.2));
            border: 1px solid rgba(255, 149, 0, 0.3);
        }
        .status-banner.complete {
            background: linear-gradient(135deg, rgba(48, 209, 88, 0.15), rgba(0, 113, 227, 0.15));
        }
    </style>
</head>
<body>
    <div class="hero">
        <p class="pill partial">Phase 1 Complete ¬∑ Phases 2-3 Pending ¬∑ November 2025</p>
        <h1>Kanata Service Strangler Fig</h1>
        <p class="tagline">From sprawling legacy managers to a single, testable fa√ßade.</p>
    </div>

    <section>
        <h2>Overall Status</h2>
        <div class="status-banner partial">
            <h2 style="color: #ff9500; margin-bottom: 10px;">‚ö†Ô∏è Phase 1 Complete ‚Äî Fa√ßade in Place</h2>
            <p style="font-size: 1.1rem;">The InstallerEngine fa√ßade is working and all callers have been migrated. However, the legacy code behind the fa√ßade has NOT been rewritten or removed.</p>
            <p style="font-size: 0.95rem; margin-top: 12px; opacity: 0.8;">60 tests passing ¬∑ Fa√ßade operational ¬∑ Legacy code still present (3,128+ lines)</p>
        </div>
        <div class="grid four" style="margin-top:24px;">
            <div class="card">
                <div class="metric">3,128</div>
                <div class="metric-label">LaunchDaemonInstaller lines</div>
                <p>Still the largest file. Hidden behind fa√ßade but not rewritten.</p>
            </div>
            <div class="card">
                <div class="metric">2,321</div>
                <div class="metric-label">RuntimeCoordinator lines</div>
                <p>Renamed from KanataManager but still contains legacy patterns.</p>
            </div>
            <div class="card">
                <div class="metric">18</div>
                <div class="metric-label">LaunchDaemonInstaller() calls</div>
                <p>Direct instantiations remaining in codebase.</p>
            </div>
            <div class="card">
                <div class="metric">20+</div>
                <div class="metric-label">Manager/Service classes</div>
                <p>Many overlapping responsibilities not yet consolidated.</p>
            </div>
        </div>
    </section>

    <section>
        <h2>Where We Started</h2>
        <div class="grid two">
            <div class="card">
                <div class="metric">7</div>
                <div class="metric-label">independent start/repair paths</div>
                <p>Wizard, CLI, Settings, helper scripts, and emergency flows all touched Kanata directly, fighting each other and prompting random admin dialogs.</p>
            </div>
            <div class="card">
                <div class="metric">5</div>
                <div class="metric-label">critical singletons with hidden side‚Äëeffects</div>
                <p>`KanataManager`, `LaunchDaemonInstaller`, `ServiceHealthMonitor`, `ProcessLifecycleManager`, and the wizard each owned their own "truth." Debugging was guesswork.</p>
            </div>
        </div>
        <div class="diagram">
            <svg viewBox="0 0 1000 220">
                <defs>
                    <linearGradient id="fade" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#ff9a8b" stop-opacity="0.8"/>
                        <stop offset="100%" stop-color="#ff6a88" stop-opacity="0.9"/>
                    </linearGradient>
                </defs>
                <rect x="30" y="40" width="940" height="140" rx="28" fill="url(#fade)" opacity="0.25"/>
                <text x="60" y="80" font-size="20" font-weight="600" fill="currentColor">2019-2024 Architecture</text>
                <text x="60" y="120" font-size="16" fill="currentColor" opacity="0.85">‚Ä¢ Multiple launchctl wrappers</text>
                <text x="60" y="150" font-size="16" fill="currentColor" opacity="0.85">‚Ä¢ Wizard owned its own PID cache & SMAppService</text>
                <text x="60" y="180" font-size="16" fill="currentColor" opacity="0.85">‚Ä¢ CLI restart logic drifted from GUI restart logic</text>
                <text x="520" y="120" font-size="16" fill="currentColor" opacity="0.85">‚Ä¢ Emergency stop bypassed privilege broker</text>
                <text x="520" y="150" font-size="16" fill="currentColor" opacity="0.85">‚Ä¢ Settings tab directly invoked InstallerEngine</text>
                <text x="520" y="180" font-size="16" fill="currentColor" opacity="0.85">‚Ä¢ SimpleMods wrote config + probed health on its own</text>
            </svg>
        </div>
    </section>

    <section>
        <h2>Phase 1: Fa√ßade Layer (‚úÖ Complete)</h2>
        <div class="grid two">
            <div class="card">
                <p class="pill done">Completed</p>
                <h3>Unified fa√ßade</h3>
                <ul>
                    <li>All start/stop/restart entry points now route through `KanataService` ‚Üí `ProcessCoordinator`.</li>
                    <li>InstallerEngine runs only from the fa√ßade, so privilege prompts are predictable.</li>
                    <li>Wizard Fix button, CLI repair, emergency stop, verbose logging toggle: same pipeline.</li>
                </ul>
            </div>
            <div class="card">
                <p class="pill done">Completed</p>
                <h3>Runtime state ingestion</h3>
                <ul>
                    <li>`RuntimeCoordinator.inspectSystemContext()` feeds Settings, Wizard, SimpleMods health checks.</li>
                    <li>`WizardStateManager` and helper docs now reflect fa√ßade-first workflows.</li>
                    <li>`SimpleModsService` post-reload validation uses the shared context snapshot.</li>
                </ul>
            </div>
        </div>
        <div class="grid three" style="margin-top:24px;">
            <div class="card">
                <div class="metric">15+</div>
                <div class="metric-label">direct call sites removed</div>
                <p>InstallerEngine is no longer instantiated from SwiftUI views, wizard controllers, or CLI tools.</p>
            </div>
            <div class="card">
                <div class="metric">60</div>
                <div class="metric-label">tests passing</div>
                <p>Full test suite runs in under 1 second.</p>
            </div>
            <div class="card">
                <div class="metric">5</div>
                <div class="metric-label">new fa√ßade APIs</div>
                <p>`getServiceStatus()`, `isServiceHealthy()`, `isServiceLoaded()`, `checkKanataServiceHealth()`, `inspectSystemContext()`</p>
            </div>
        </div>
    </section>

    <section>
        <h2>Phase 2: Internal Rewrite (üî∂ Not Started)</h2>
        <p style="color: var(--gray); margin-bottom: 24px;">Replace legacy implementations behind the fa√ßade with clean, testable services.</p>
        <table class="table">
            <thead>
                <tr>
                    <th>Task</th>
                    <th>Current State</th>
                    <th>Target</th>
                    <th>Effort</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Decompose LaunchDaemonInstaller</strong></td>
                    <td>3,128 lines, 71 functions in one file</td>
                    <td>Split into: PlistGenerator, ServiceBootstrapper, HealthChecker, BinaryInstaller</td>
                    <td><span class="effort">~3-4 days</span></td>
                </tr>
                <tr>
                    <td><strong>Extract RuntimeCoordinator concerns</strong></td>
                    <td>2,321 lines mixing UI state, process lifecycle, config management</td>
                    <td>Separate: ProcessLifecycle, ConfigReloader, StatePublisher</td>
                    <td><span class="effort">~2-3 days</span></td>
                </tr>
                <tr>
                    <td><strong>Consolidate Manager classes</strong></td>
                    <td>20+ overlapping managers (KanataDaemonManager, KanataConfigManager, BundledKanataManager, etc.)</td>
                    <td>Merge into InstallerEngine subsystems or delete</td>
                    <td><span class="effort">~2 days</span></td>
                </tr>
                <tr>
                    <td><strong>Remove LaunchDaemonInstaller() direct calls</strong></td>
                    <td>18 direct instantiations remaining</td>
                    <td>All calls go through InstallerEngine fa√ßade</td>
                    <td><span class="effort">~1 day</span></td>
                </tr>
                <tr>
                    <td><strong>Add unit tests for new services</strong></td>
                    <td>Tests exist but cover fa√ßade, not internals</td>
                    <td>Each new service has isolated unit tests</td>
                    <td><span class="effort">~2 days</span></td>
                </tr>
            </tbody>
        </table>
        <div class="card" style="margin-top: 24px;">
            <p class="pill pending">Estimated Total: 10-14 days</p>
            <p>This phase requires careful incremental work to avoid regressions. Each decomposition should be a separate PR with full test coverage.</p>
        </div>
    </section>

    <section>
        <h2>Phase 3: Legacy Removal (üî∂ Not Started)</h2>
        <p style="color: var(--gray); margin-bottom: 24px;">Delete legacy code once new implementations are verified.</p>
        <table class="table">
            <thead>
                <tr>
                    <th>Task</th>
                    <th>Blocked By</th>
                    <th>Lines to Remove</th>
                    <th>Effort</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Delete LaunchDaemonInstaller.swift</strong></td>
                    <td>Phase 2 decomposition complete</td>
                    <td>~3,000 lines</td>
                    <td><span class="effort">~1 day</span></td>
                </tr>
                <tr>
                    <td><strong>Remove duplicate Manager classes</strong></td>
                    <td>Consolidation in Phase 2</td>
                    <td>~1,500 lines</td>
                    <td><span class="effort">~1 day</span></td>
                </tr>
                <tr>
                    <td><strong>Clean up RuntimeCoordinator</strong></td>
                    <td>Extraction in Phase 2</td>
                    <td>~1,000 lines</td>
                    <td><span class="effort">~1 day</span></td>
                </tr>
                <tr>
                    <td><strong>Archive legacy documentation</strong></td>
                    <td>Code removal complete</td>
                    <td>N/A</td>
                    <td><span class="effort">~0.5 day</span></td>
                </tr>
                <tr>
                    <td><strong>Final test sweep & cleanup</strong></td>
                    <td>All removal complete</td>
                    <td>N/A</td>
                    <td><span class="effort">~1 day</span></td>
                </tr>
            </tbody>
        </table>
        <div class="card" style="margin-top: 24px;">
            <p class="pill pending">Estimated Total: 4-5 days</p>
            <p>Target: Remove ~5,500 lines of legacy code. Final codebase should be ~40% smaller with clearer separation of concerns.</p>
        </div>
    </section>

    <section>
        <h2>Completed Work (Phase 1)</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Stage</th>
                    <th>Details</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>1. Internalize Repair Recipes</strong></td>
                    <td>
                        Collapsed `LaunchDaemonInstaller` actions into `InstallerEngine+Recipes`. Ported wizard-only driver flows. Reports now contain structured metadata with logs and commands.
                    </td>
                    <td><span class="pill done">‚úÖ Complete</span></td>
                </tr>
                <tr>
                    <td><strong>2. Expose Health Check APIs</strong></td>
                    <td>
                        Added fa√ßade methods: `getServiceStatus()`, `isServiceHealthy()`, `isServiceLoaded()`, `checkKanataServiceHealth()`. Migrated callers from direct `LaunchDaemonInstaller` usage.
                    </td>
                    <td><span class="pill done">‚úÖ Complete</span></td>
                </tr>
                <tr>
                    <td><strong>3. Test Sweep</strong></td>
                    <td>
                        Added `InstallerEngineHealthCheckTests` with 11 tests. Verified existing tests pass with fa√ßade changes. Updated documentation.
                    </td>
                    <td><span class="pill done">‚úÖ Complete</span></td>
                </tr>
                <tr>
                    <td><strong>4. Slim Legacy Public API</strong></td>
                    <td>
                        Made 8 methods private, kept 5 internal for testing. Reduced API surface while maintaining test coverage.
                    </td>
                    <td><span class="pill done">‚úÖ Complete</span></td>
                </tr>
                <tr>
                    <td><strong>5. Documentation Update</strong></td>
                    <td>
                        Updated NEW_DEVELOPER_GUIDE.md with InstallerEngine fa√ßade. Verified Scripts are organized.
                    </td>
                    <td><span class="pill done">‚úÖ Complete</span></td>
                </tr>
                <tr>
                    <td><strong>6. Critical Issue Detection</strong></td>
                    <td>
                        Added `bundledKanataMissing` component requirement for corrupted app bundles. Critical severity wizard issue.
                    </td>
                    <td><span class="pill done">‚úÖ Complete</span></td>
                </tr>
                <tr>
                    <td><strong>7. Privileged Helper Docs</strong></td>
                    <td>
                        HELPER.md Phase 4 documentation complete. Architecture diagrams, security model, troubleshooting guides.
                    </td>
                    <td><span class="pill done">‚úÖ Complete</span></td>
                </tr>
            </tbody>
        </table>
    </section>

    <section>
        <h2>Other Pending Work</h2>
        <div class="grid two">
            <div class="card">
                <p class="pill next">Future</p>
                <h3>Kanata v1.10 driver update</h3>
                <p>When kanata v1.10 is released, update `requiredDriverVersionMajor` to 6 in `VHIDDeviceManager.swift`. This is tracked as a TODO in the codebase.</p>
            </div>
            <div class="card">
                <p class="pill next">Maintainer Task</p>
                <h3>Privileged helper testing</h3>
                <p>Test release build workflow with certificate. Test helper installation/upgrade flow. Test fallback to sudo if helper unavailable. Requires maintainer with signing certificate.</p>
            </div>
        </div>
    </section>

    <section>
        <h2>Timeline</h2>
        <div class="timeline">
            <div class="timeline-item">
                <h3>Phase 1.1 ¬∑ Surface Coordination <span class="pill done">Done</span></h3>
                <p>Unified start/stop/restart UX across the app, CLI, wizard, and emergency flows.</p>
            </div>
            <div class="timeline-item">
                <h3>Phase 1.2 ¬∑ Health & Diagnostics <span class="pill done">Done</span></h3>
                <p>Service health checks, diagnostics, and SimpleMods all share `inspectSystemContext()` snapshots.</p>
            </div>
            <div class="timeline-item">
                <h3>Phase 1.3 ¬∑ Helper & Docs Refresh <span class="pill done">Done</span></h3>
                <p>Developers now learn the fa√ßade-first flow on day one; legacy docs are clearly marked historical.</p>
            </div>
            <div class="timeline-item">
                <h3>Phase 1.4 ¬∑ Fa√ßade APIs <span class="pill done">Done</span></h3>
                <p>Repair recipes internalized, health check APIs exposed, callers migrated to fa√ßade.</p>
            </div>
            <div class="timeline-item">
                <h3>Phase 2 ¬∑ Internal Rewrite <span class="pill pending">Pending</span></h3>
                <p>Decompose LaunchDaemonInstaller (3,128 lines) into clean, testable services. Extract RuntimeCoordinator concerns. Consolidate overlapping managers.</p>
            </div>
            <div class="timeline-item">
                <h3>Phase 3 ¬∑ Legacy Removal <span class="pill pending">Pending</span></h3>
                <p>Delete legacy code (~5,500 lines). Archive old documentation. Final test sweep.</p>
            </div>
        </div>
        <div class="status-banner partial" style="margin-top: 40px;">
            <h2 style="color: #ff9500; margin-bottom: 10px;">üìä Project Status: Phase 1 of 3 Complete</h2>
            <p style="font-size: 1.1rem;">Fa√ßade is operational. Legacy code is hidden but not yet replaced.</p>
            <p style="font-size: 0.95rem; margin-top: 12px; opacity: 0.8;">
                <strong>Remaining effort:</strong> ~14-19 days to complete Phases 2-3
            </p>
        </div>
    </section>

    <footer>
        Built with ‚ù§Ô∏è by the KeyPath team ¬∑ "Great tools feel invisible." ‚Äî Apple Engineering Playbook
    </footer>
</body>
</html>
