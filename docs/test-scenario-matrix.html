<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KeyPath Test Scenario Matrix</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 2rem; background: #f6f7fb; }
    h1 { margin-top: 0; }
    table { border-collapse: collapse; width: 100%; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #dfe2e6; padding: 0.75rem; text-align: left; vertical-align: top; }
    th { background: #f0f2f5; font-weight: 600; }
    .status { font-weight: 600; }
    .yes { color: #0f8a00; }
    .partial { color: #b36b00; }
    .no { color: #b00020; }
    .na { color: #4d596a; }
    caption { text-align: left; font-weight: 600; margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <h1>KeyPath Test Scenario Matrix</h1>
  <p>Snapshot generated November 16, 2025 after the privileged-command harness, installer report, and log rotation coverage push.</p>
  <table>
    <caption>Refactor Safety Coverage</caption>
    <thead>
      <tr>
        <th>Scenario</th>
        <th>Has test?</th>
        <th>Happy-path</th>
        <th>Failure-path</th>
        <th>Idempotence</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Fresh install (all deps present)</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td>InstallerEngineFunctionalTests cover provisioning/SMAppService flows, IntegrationTestSuite now asserts that installer failures surface errors, <code>LaunchctlSmokeTests</code> and <code>AuthorizationServicesSmokeTests</code> disable test mode to exercise the real launchctl/Authorization Services pipelines via shims, and <code>InstallerReport</code> captures admin failures for triage.</td>
      </tr>
      <tr>
        <td>Re-run install on already-installed</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td>Re-run tests now cover happy-path duplication and failure-path logging when the launch daemon directory is locked, so the installer surfaces the same errors that would hit users.</td>
      </tr>
      <tr>
        <td>Duplicate/plist leftovers</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td>Tests now emulate leftover plist directories so installer logging & return values capture the failure path, ensuring duplicates trigger observable errors.</td>
      </tr>
      <tr>
        <td>Duplicate app copies / helper cleanup</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td>HelperMaintenance tests cover duplicate detection, idempotent cleanup, and now assert the AdminCommandExecutor-based fallback’s success and failure logs so regressions surface immediately.</td>
      </tr>
      <tr>
        <td>Missing VirtualHID services</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td>Repair + restart flow fully validated.</td>
      </tr>
      <tr>
        <td>Missing Kanata binary</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td>Installer tests assert log guidance when system/bundled binaries are absent.</td>
      </tr>
      <tr>
        <td>Permission denied on key folder</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td>Installer now creates a read-only ~/.config tree in tests to confirm the “Failed to create default user config” guidance appears whenever permission issues block the key folder.</td>
      </tr>
      <tr>
        <td>SMAppService approval pending</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td>Functional test awaits `.smAppServiceApprovalRequired` notification; privilege-denial UX is guarded.</td>
      </tr>
      <tr>
        <td>VirtualHID repair</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td>Repair flow restores VHID plists + health.</td>
      </tr>
      <tr>
        <td>Uninstall / cleanup</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td>Functional tests exercise both the successful cleanup and failure modes (missing script + admin-denied errors) so the happy and failure paths are locked in; only partial failure-state reporting still relies on log assertions.</td>
      </tr>
      <tr>
        <td>Log rotation / admin command harness</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td><code>LogRotationTests</code> plus <code>PrivilegedOperationsCoordinatorTests</code> run the AdminCommandExecutor shim, so both the success case and command failures now produce machine-readable installer reports.</td>
      </tr>
      <tr>
        <td>Config watcher atomic write handling</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td class="status na">N/A</td>
        <td>New ConfigFileWatcher test exercises the async debounce/task path and ensures a single callback fires when multiple writes occur.</td>
      </tr>
    </tbody>
  </table>
  <p><strong>Reality check:</strong> (1) The CI runner (<code>run-core-tests.sh</code>) still filters to <code>UnitTestSuite</code> unless <code>CI_INTEGRATION_TESTS=true</code>, so installer/privileged suites can be skipped silently. (2) <code>LaunchctlSmokeTests</code> and <code>AuthorizationServicesSmokeTests</code> now run outside <code>KEYPATH_TEST_MODE</code> with fake binaries, but we should still spot-check the real Authorization Services/osascript flows on a developer machine before large releases. (3) HelperMaintenance’s legacy cleanup path is exercised through the AdminCommandExecutor seam, so failures surface immediately; the helper parity plan simply tracks future migration work.</p>
  <section>
    <h2>Local Refactor Safety Checklist</h2>
    <ol>
      <li>From repo root, run <code>CI_INTEGRATION_TESTS=true ./run-core-tests.sh</code>. This keeps the fast suites but also executes the installer/privileged smoke tests that rely on the AdminCommandExecutor and launchctl shims.</li>
      <li>Review <code>test-results/Integration Tests.log</code> for failures in <code>InstallerEngineFunctionalTests</code>, <code>PrivilegedOperationsCoordinatorTests</code>, <code>LaunchctlSmokeTests</code>, <code>AuthorizationServicesSmokeTests</code>, <code>LogRotationTests</code>, and <code>HelperMaintenanceTests</code>.</li>
      <li>If you need to exercise the real Authorization Services path (no shims), temporarily unset <code>KEYPATH_TEST_MODE</code> and run the targeted scenario manually; document the run in your refactor PR.</li>
    </ol>
    <p>This checklist replaces the need for GitHub-hosted macOS runners; every refactor branch should capture the outcome of these local runs in the PR description.</p>
  </section>
  <section>
    <h2>Pre-Refactor Checklist</h2>
    <ol>
      <li><strong>Helper parity plan ready:</strong> see <code>docs/helper-parity-plan.md</code> for the mapping of every AppleScript entry point to its future helper RPC. Treat it as the playbook during the actual helper migration.</li>
    </ol>
    <p>No additional guardrails are required before starting the installer refactor; just follow the local safety checklist and consult the parity plan while you rewrite the privileged flows.</p>
  </section>
  <section>
    <h2>Refactor Readiness</h2>
    <p><strong>Confidence:</strong> High. Fresh installs, reruns, repair flows, helper cleanup, log rotation, launchctl loading, and Authorization Services now have deterministic tests that exercise real file writes and shimmed privileged commands. Run <code>CI_INTEGRATION_TESTS=true ./run-core-tests.sh</code> (per the checklist above) whenever you branch for the refactor.</p>
    <p><strong>Remaining watch-outs:</strong> (1) Keep an eye on the PATH overrides used by <code>LaunchctlSmokeTests</code> and <code>AuthorizationServicesSmokeTests</code>—if the installer scripts add new binaries, update the stubs. (2) When you begin swapping in the helper RPCs, update the AdminCommandExecutor-based tests to point at helper stubs so they keep covering the new paths.</p>
    <p>With those practices, the existing suite is strong enough to act as a safety net while you rewire the installer to rely solely on the privileged helper.</p>
  </section>
</body>
</html>
