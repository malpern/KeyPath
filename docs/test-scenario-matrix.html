<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KeyPath Test Scenario Matrix</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 2rem; background: #f6f7fb; }
    h1 { margin-top: 0; }
    table { border-collapse: collapse; width: 100%; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #dfe2e6; padding: 0.75rem; text-align: left; vertical-align: top; }
    th { background: #f0f2f5; font-weight: 600; }
    .status { font-weight: 600; }
    .yes { color: #0f8a00; }
    .partial { color: #b36b00; }
    .no { color: #b00020; }
    .na { color: #4d596a; }
    caption { text-align: left; font-weight: 600; margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <h1>KeyPath Test Scenario Matrix</h1>
  <p>Snapshot generated November 15, 2025 after the newest installer, watcher, and uninstall coverage push.</p>
  <table>
    <caption>Refactor Safety Coverage</caption>
    <thead>
      <tr>
        <th>Scenario</th>
        <th>Has test?</th>
        <th>Happy-path</th>
        <th>Failure-path</th>
        <th>Idempotence</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Fresh install (all deps present)</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td>InstallerEngineFunctionalTests cover provisioning/SMAppService flows, and IntegrationTestSuite now asserts that installer failures surface errors; default CI still filters to <code>UnitTestSuite</code> so developers must opt in locally.</td>
      </tr>
      <tr>
        <td>Re-run install on already-installed</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td>Re-run tests now cover happy-path duplication and failure-path logging when the launch daemon directory is locked, so the installer surfaces the same errors that would hit users.</td>
      </tr>
      <tr>
        <td>Duplicate/plist leftovers</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td>Tests now emulate leftover plist directories so installer logging & return values capture the failure path, ensuring duplicates trigger observable errors.</td>
      </tr>
      <tr>
        <td>Duplicate app copies / helper cleanup</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td>HelperMaintenance now has tests covering duplicate detection, warning logs when non-/Applications copies exist, and idempotent cleanup runs with mocked helper steps.</td>
      </tr>
      <tr>
        <td>Missing VirtualHID services</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td>Repair + restart flow fully validated.</td>
      </tr>
      <tr>
        <td>Missing Kanata binary</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td>Installer tests assert log guidance when system/bundled binaries are absent.</td>
      </tr>
      <tr>
        <td>Permission denied on key folder</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td>Installer now creates a read-only ~/.config tree in tests to confirm the “Failed to create default user config” guidance appears whenever permission issues block the key folder.</td>
      </tr>
      <tr>
        <td>SMAppService approval pending</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td>Functional test awaits `.smAppServiceApprovalRequired` notification; privilege-denial UX is guarded.</td>
      </tr>
      <tr>
        <td>VirtualHID repair</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td>Repair flow restores VHID plists + health.</td>
      </tr>
      <tr>
        <td>Uninstall / cleanup</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td>Functional tests exercise both the successful cleanup and failure modes (missing script + admin-denied errors) so the happy and failure paths are locked in; only partial failure-state reporting still relies on log assertions.</td>
      </tr>
      <tr>
        <td>Config watcher atomic write handling</td>
        <td class="status yes">Yes</td>
        <td class="status yes">Yes</td>
        <td class="status na">N/A</td>
        <td class="status na">N/A</td>
        <td>New ConfigFileWatcher test exercises the async debounce/task path and ensures a single callback fires when multiple writes occur.</td>
      </tr>
    </tbody>
  </table>
  <p><strong>Reality check:</strong> (1) The CI runner (<code>run-core-tests.sh</code>) executes <code>swift test --filter UnitTestSuite</code> twice, so installer/privilege suites still require <code>CI_INTEGRATION_TESTS=true</code> to execute. (2) HelperMaintenance now has duplicate detection coverage, and uninstall report logging is exercised, yet production Admin/AppleScript fallbacks still rely on logs instead of structured errors. (3) Several failure-path rows lean on log assertions rather than visible exit codes, so these should be expanded before a large refactor.</p>
  <section>
    <h2>Outstanding To-Do Items</h2>
    <ul>
      <li><strong>CI integration gating:</strong> document and/or automate `CI_INTEGRATION_TESTS=true ./run-core-tests.sh` so the installer/privileged suites run whenever we branch for refactors; today the default CI flow skips them, so a human must opt in.</li>
      <li><strong>Installer report artifacts:</strong> we currently assert on log output for failure cases; consider emitting a structured `InstallerReport` (or at least a well-defined exit status) so future refactors can assert on machine-readable outcomes instead of strings.</li>
      <li><strong>Helper cleanup fallback coverage:</strong> the AppleScript/legacy artifact removal paths are still untested; add a harness that simulates fallback failures so we verify the UI/log guidance and any `removeLegacyHelperArtifacts` fallbacks before the refactor.</li>
    </ul>
  </section>
</body>
</html>
